<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>uptrace.lol - Status Dashboard</title>
<style>
  :root{
    --bg:#0d1117;--card:#161b22;--border:#30363d;--text:#c9d1d9;--sub:#8b949e;
    --accent:#58a6ff;--danger:#d2344e;--ok:#00c17c;
    --radius:14px;
    --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  }
  body{font-family:var(--font);background:var(--bg);color:var(--text);padding:24px;max-width:980px;margin:auto}
  h1{margin:0 0 6px 0;font-size:20px}
  .sub{color:var(--sub);font-size:13px;margin-bottom:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
  .card h2{margin:0 0 12px 0;font-size:16px}
  input,select,textarea{
    padding:8px 10px;border-radius:10px;border:1px solid var(--border);
    background:#0b0f14;color:var(--text);font-size:14px;width:100%;box-sizing:border-box
  }
  textarea{resize:vertical;min-height:88px}
  label{font-weight:700;display:block;margin:10px 0 6px}
  button{
    padding:9px 12px;border-radius:10px;border:1px solid var(--border);
    background:#202636;color:var(--text);font-weight:700;cursor:pointer
  }
  button:hover{border-color:var(--accent)}
  .btn-primary{background:#1f3b66;border-color:#274b82}
  .btn-danger{background:#3a1820;border-color:#5c1f2c;color:#ffd6dc}
  .btn-ghost{background:transparent}
  .pill{display:inline-flex;gap:10px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;color:var(--sub)}
  .muted{color:var(--sub);font-size:13px}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.split{grid-template-columns:1fr}}
  .service{border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}
  .service-header{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .service-name{font-weight:800}
  .hr{height:1px;background:var(--border);margin:14px 0}
  .toast{position:fixed;right:18px;bottom:18px;background:#0b0f14;border:1px solid var(--border);border-radius:12px;padding:12px 14px;opacity:0;transform:translateY(8px);transition:.18s;z-index:9999}
  .toast.show{opacity:1;transform:none}
  .grid3{display:grid;grid-template-columns:1.1fr .9fr 1fr;gap:10px}
  @media(max-width:900px){.grid3{grid-template-columns:1fr}}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  
  /* NEW: Fix visibility for datetime picker icon in dark mode */
  input[type="datetime-local"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>Status Dashboard</h1>
<div class="sub">Login → create a project → add services → publish a public status page.</div>

<div id="toast" class="toast"></div>

<div id="authCard" class="card">
  <h2>Login / Register</h2>
  <div class="row">
    <div style="flex:1;min-width:240px">
      <label>Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email">
    </div>
    <div style="flex:1;min-width:240px">
      <label>Password</label>
      <input id="password" type="password" placeholder="••••••••" autocomplete="current-password">
    </div>
  </div>
  <div class="row" style="margin-top:12px">
    <button class="btn-primary" id="btnLogin">Login</button>
    <button id="btnRegister">Register</button>
  </div>
  <div class="muted" style="margin-top:10px">
    Tip: Buy us a coffee. Its NOT free! Thanks!11
  </div>
</div>

<div id="app" style="display:none">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
    <div class="pill">
      <span>Signed in as</span>
      <code id="userEmail">—</code>
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button class="btn-ghost" id="btnAccount">Account</button>
      <button class="btn-ghost" id="btnLogout">Logout</button>
    </div>
  </div>

  <div id="accountCard" class="card" style="margin-bottom:12px;display:none">
    <h2>Account</h2>

    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="pill">
        <span>UID</span>
        <code id="userUid">—</code>
      </div>
      <div class="pill">
        <span>Email verified</span>
        <code id="emailVerified">—</code>
      </div>
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <label>Username (optional)</label>
        <input id="username" type="text" placeholder="noxy" maxlength="24">
        <div class="row" style="margin-top:10px">
          <button class="btn-primary" id="btnSaveUsername">Save username</button>
        </div>
        <div class="muted" style="margin-top:8px">
          Stored in Realtime DB at <code>users/&lt;uid&gt;/profile</code>.
        </div>
      </div>

      <div>
        <label>Verify your email</label>
        <div class="row" style="margin-top:6px">
          <button id="btnSendVerify" class="btn-primary">Send verification email</button>
          <button id="btnRefreshUser">Refresh status</button>
        </div>

        <div class="hr"></div>

        <label>Change email</label>
        <input id="newEmail" type="email" placeholder="new@email.com">
        <div class="row" style="margin-top:10px">
          <button id="btnChangeEmail" class="btn-primary">Change email</button>
        </div>

        <div class="hr"></div>

        <label>Change password</label>
        <input id="newPassword" type="password" placeholder="New password (6+ chars)">
        <div class="row" style="margin-top:10px">
          <button id="btnChangePassword" class="btn-primary">Change password</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row" style="align-items:center;justify-content:space-between">
      <div>
        <div style="font-weight:800">Export all data</div>
        <div class="muted">Downloads a JSON containing your projects and their data.</div>
      </div>
      <button id="btnExportData">Export JSON</button>
    </div>

    <div class="hr"></div>

    <div class="row" style="align-items:center;justify-content:space-between">
      <div>
        <div style="font-weight:800;color:#ffd6dc">Account deletion</div>
        <div class="muted">No servers here: you can request deletion (flag) or delete instantly.</div>
      </div>
      <button class="btn-danger" id="btnDeleteAccount">Delete instantly</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn-ghost" id="btnRequestDeletion">Request deletion (store flag)</button>
    </div>
  </div>

  <div class="split">
    <div class="card">
      <h2>Projects</h2>

      <label>Your projects</label>
      <select id="projectSelect"></select>

      <div class="row" style="margin-top:10px">
        <button id="btnCreateProject" class="btn-primary">+ Create project</button>
        <button id="btnOpenPublic">Open public page</button>
      </div>

      <div class="hr"></div>

      <label>Project name</label>
      <input id="projectName" type="text" placeholder="My API / My App">

      <label>Project slug (public URL)</label>
      <input id="projectSlug" type="text" placeholder="my-api" maxlength="40">

      <div class="row" style="margin-top:10px;align-items:center">
        <label style="margin:0;display:flex;gap:8px;align-items:center;font-weight:700">
          <input id="projectPublic" type="checkbox" style="width:auto">
          Public
        </label>
        <span class="muted">If off, only members can view status.</span>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnSaveProject" class="btn-primary">Save project</button>
      </div>

      <div class="muted" style="margin-top:12px">
        Public URL will be: <code>status.html?project=&lt;slug&gt;</code>
      </div>
    </div>

    <div class="card">
      <h2>Announcement</h2>
      <label>General announcement text</label>
      <textarea id="announcement" placeholder="Maintenance window, incident update, etc."></textarea>
      <div class="row" style="margin-top:10px">
        <button id="btnSaveAnnouncement" class="btn-primary">Save announcement</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2>Services</h2>

    <div class="row">
      <div style="flex:1;min-width:240px">
        <label>New service name</label>
        <input id="newServiceName" type="text" placeholder="API, Website, Auth, Payments…">
      </div>
      <div style="width:180px;min-width:160px">
        <label>Order</label>
        <input id="newServiceOrder" type="number" value="0">
      </div>
      <div style="align-self:flex-end">
        <button id="btnAddService" class="btn-primary">Add service</button>
      </div>
    </div>

    <div class="hr"></div>

    <div id="services"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2>Legacy import (optional)</h2>
    <div class="muted">
      If you previously used <code>statusApps</code> at the DB root, you can import it here.
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnImportLegacy">Import legacy statusApps → services</button>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  sendEmailVerification,
  updateEmail,
  updatePassword,
  deleteUser,
  EmailAuthProvider,
  reauthenticateWithCredential,
  verifyBeforeUpdateEmail
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  ref, get, set, update, push, remove, onValue, child
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const $ = (q)=>document.querySelector(q);

function toast(msg){
  const el = $("#toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 2400);
}

function slugify(s){
  return String(s||"")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/^-+|-+$/g,'')
    .slice(0,40);
}

function now(){ return Date.now(); }

// Helper for datetime-local inputs (Local Time -> YYYY-MM-DDTHH:mm)
function toLocalISO(date) {
    const pad = n => n < 10 ? '0' + n : n;
    return date.getFullYear() + '-' + pad(date.getMonth() + 1) + '-' + pad(date.getDate()) + 'T' + pad(date.getHours()) + ':' + pad(date.getMinutes());
}

let currentUid = null;
let currentProjectId = null;
let currentRole = null;
let servicesUnsub = null;
let projectUnsub = null;

async function getRole(projectId, uid){
  const snap = await get(ref(db, `projectMembers/${projectId}/${uid}/role`));
  return snap.val() || null;
}

function requireProject(){
  if(!currentProjectId) throw new Error("Pick a project first.");
}

/* ---------------- ACCOUNT HELPERS ---------------- */
async function promptReauth(user){
  if(!user?.email) throw new Error("Re-auth requires an email/password account.");
  const pass = prompt("For security, re-enter your current password:");
  if(!pass) throw new Error("Re-auth cancelled");
  const cred = EmailAuthProvider.credential(user.email, pass);
  await reauthenticateWithCredential(user, cred);
}

function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ---------------- AUTH UI ---------------- */
$("#btnRegister").addEventListener("click", async ()=>{
  const email = $("#email").value.trim();
  const pass  = $("#password").value;
  if(!email || pass.length<6){ toast("Email + password (6+ chars)"); return; }
  try{
    await createUserWithEmailAndPassword(auth, email, pass);
    toast("Registered!");
  }catch(e){ toast(e.message); }
});

$("#btnLogin").addEventListener("click", async ()=>{
  const email = $("#email").value.trim();
  const pass  = $("#password").value;
  if(!email || !pass){ toast("Enter email + password"); return; }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    toast("Logged in!");
  }catch(e){ toast(e.message); }
});

$("#btnAccount").addEventListener("click", ()=>{
  const card = $("#accountCard");
  card.style.display = card.style.display !== "none" ? "none" : "block";
});

$("#btnLogout").addEventListener("click", async ()=>{ await signOut(auth); });

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    currentUid = null; currentProjectId = null; currentRole = null;
    $("#authCard").style.display = "block";
    $("#app").style.display = "none";
    return;
  }
  currentUid = user.uid;
  $("#userEmail").textContent = user.email || user.uid;
  $("#userUid").textContent = user.uid;
  $("#emailVerified").textContent = user.emailVerified ? "yes" : "no";

  try{
    const profSnap = await get(ref(db, `users/${user.uid}/profile`));
    const prof = profSnap.val() || {};
    $("#username").value = prof.username || "";
    if(!prof.createdAt) await update(ref(db, `users/${user.uid}/profile`), { createdAt: now() });
  }catch(_){}

  $("#authCard").style.display = "none";
  $("#app").style.display = "block";
  await loadProjects();
});

/* ---------------- ACCOUNT ACTIONS ---------------- */
$("#btnRefreshUser").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  try{
    await user.reload();
    $("#userEmail").textContent = user.email || user.uid;
    $("#emailVerified").textContent = user.emailVerified ? "yes" : "no";
    toast("Refreshed");
  }catch(e){ toast(e.message); }
});

$("#btnSendVerify").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  try{ await sendEmailVerification(user); toast("Verification email sent"); }catch(e){ toast(e.message); }
});

$("#btnSaveUsername").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  const username = ($("#username").value || "").trim();
  if(username.length > 24){ toast("Username max 24 chars"); return; }
  try{ await update(ref(db, `users/${user.uid}/profile`), { username }); toast("Username saved"); }catch(e){ toast(e.message); }
});

$("#btnChangeEmail").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  const newEmail = ($("#newEmail").value || "").trim();
  if(!newEmail){ toast("Enter new email"); return; }
  try{
    await verifyBeforeUpdateEmail(user, newEmail);
    toast("Check NEW email to confirm");
    $("#newEmail").value = "";
  }catch(e){
    if(String(e.code).includes("requires-recent-login")){
      try{ await promptReauth(user); await verifyBeforeUpdateEmail(user, newEmail); toast("Check NEW email"); }catch(e2){ toast(e2.message); }
    }else{ toast(e.message); }
  }
});

$("#btnChangePassword").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  const newPass = ($("#newPassword").value || "");
  if(newPass.length < 6){ toast("Password 6+ chars"); return; }
  try{
    await updatePassword(user, newPass);
    toast("Password updated");
    $("#newPassword").value = "";
  }catch(e){
    if(String(e.code).includes("requires-recent-login")){
      try{ await promptReauth(user); await updatePassword(user, newPass); toast("Password updated"); }catch(e2){ toast(e2.message); }
    }else{ toast(e.message); }
  }
});

$("#btnRequestDeletion").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  try{ await update(ref(db, `users/${user.uid}/profile`), { deletionRequestedAt: now() }); toast("Deletion request stored"); }catch(e){ toast(e.message); }
});

$("#btnDeleteAccount").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!confirm("DELETE account instantly?")) return;
  try{
    await deleteUser(user); toast("Account deleted");
  }catch(e){
    if(String(e.code).includes("requires-recent-login")){
      try{ await promptReauth(user); await deleteUser(user); toast("Account deleted"); }catch(e2){ toast(e2.message); }
    }else{ toast(e.message); }
  }
});

$("#btnExportData").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  try{
    toast("Generating export...");
    const up = await get(ref(db, `userProjects/${user.uid}`));
    const ids = Object.keys(up.val() || {});
    const out = { exportedAt: new Date().toISOString(), uid: user.uid, projects: {} };

    for(const pid of ids){
      const meta = (await get(ref(db, `projects/${pid}`))).val();
      const services = (await get(ref(db, `services/${pid}`))).val() || {};
      const announcement = (await get(ref(db, `announcements/${pid}`))).val() || {};
      if(meta) out.projects[pid] = { meta, services, announcement };
    }
    downloadJson(`export-${user.uid}.json`, out);
    toast("Exported");
  }catch(e){ toast(e.message); }
});

/* ---------------- PROJECTS ---------------- */
async function loadProjects(){
  const snap = await get(ref(db, `userProjects/${currentUid}`));
  const ids = Object.keys(snap.val() || {});
  const sel = $("#projectSelect");
  sel.innerHTML = "";
  if(ids.length===0){
    const opt = document.createElement("option"); opt.value = ""; opt.textContent = "No projects"; sel.appendChild(opt);
    currentProjectId = null; return;
  }
  for(const id of ids){
    const opt = document.createElement("option"); opt.value = id; opt.textContent = id; sel.appendChild(opt);
  }
  sel.value = ids[0];
  await selectProject(ids[0]);
}

$("#projectSelect").addEventListener("change", async ()=>{
  const id = $("#projectSelect").value;
  if(id) await selectProject(id);
});

async function selectProject(projectId){
  currentProjectId = projectId;
  currentRole = await getRole(projectId, currentUid);
  
  if(projectUnsub) projectUnsub();
  projectUnsub = onValue(ref(db, `projects/${projectId}`), snap=>{
    const p = snap.val() || {};
    $("#projectName").value = p.name || "";
    $("#projectSlug").value = p.slug || "";
    $("#projectPublic").checked = !!p.public;
  });

  onValue(ref(db, `announcements/${projectId}`), snap=>{
    $("#announcement").value = (snap.val()||{}).text || "";
  }, { onlyOnce: false });

  mountServicesListener();
  toast(`Loaded: ${projectId}`);
}

$("#btnCreateProject").addEventListener("click", async ()=>{
  const name = prompt("Project name?");
  if(!name) return;
  const slug = slugify(name);
  try{
    const pid = push(ref(db, "projects")).key;
    await set(ref(db, `projects/${pid}`), { name, slug, ownerUid: currentUid, public: true, createdAt: now() });
    await set(ref(db, `projectMembers/${pid}/${currentUid}`), { role: "owner" });
    await set(ref(db, `userProjects/${currentUid}/${pid}`), true);
    await set(ref(db, `projectSlugs/${slug}`), pid);
    toast("Project created");
    await loadProjects();
    $("#projectSelect").value = pid;
    await selectProject(pid);
  }catch(e){ toast(e.message); }
});

$("#btnSaveProject").addEventListener("click", async ()=>{
  requireProject();
  if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
  const name = $("#projectName").value.trim();
  const slug = slugify($("#projectSlug").value);
  const isPublic = $("#projectPublic").checked;

  if(!name){ toast("Name required"); return; }
  try{
    const oldSnap = await get(ref(db, `projects/${currentProjectId}/slug`));
    const oldSlug = oldSnap.val();
    const updates = {};
    updates[`projects/${currentProjectId}/name`] = name;
    updates[`projects/${currentProjectId}/slug`] = slug;
    updates[`projects/${currentProjectId}/public`] = isPublic;
    if(oldSlug && oldSlug !== slug) updates[`projectSlugs/${oldSlug}`] = null;
    updates[`projectSlugs/${slug}`] = currentProjectId;
    await update(ref(db), updates);
    toast("Saved");
  }catch(e){ toast(e.message); }
});

$("#btnOpenPublic").addEventListener("click", async ()=>{
  requireProject();
  const snap = await get(ref(db, `projects/${currentProjectId}/slug`));
  const slug = snap.val();
  if(slug) window.open(`status.html?project=${encodeURIComponent(slug)}`, "_blank");
});

$("#btnSaveAnnouncement").addEventListener("click", async ()=>{
  requireProject();
  if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
  await set(ref(db, `announcements/${currentProjectId}`), { text: $("#announcement").value, updatedAt: now() });
  toast("Announcement saved");
});

/* ---------------- SERVICES (UPDATED FOR HOURLY LOGIC) ---------------- */
function mountServicesListener(){
  onValue(ref(db, `services/${currentProjectId}`), snap=>{
    const services = snap.val() || {};
    const entries = Object.entries(services)
      .map(([id,s])=>({id,...s}))
      .sort((a,b)=>(a.order??0)-(b.order??0));
    
    const holder = $("#services");
    holder.innerHTML = "";
    if(entries.length===0){ holder.innerHTML = `<div class="muted">No services yet.</div>`; return; }
    
    entries.forEach(s => holder.appendChild(renderServiceCard(s)));
  });
}

function renderServiceCard(s){
  const wrap = document.createElement("div");
  wrap.className = "service";
  // UPDATED: Default to current Local ISO time for the picker
  const defaultDate = toLocalISO(new Date());

  wrap.innerHTML = `
    <div class="service-header">
      <div>
        <div class="service-name">${escapeHtml(s.name||"Unnamed")}</div>
        <div class="muted">id: <code>${s.id}</code></div>
      </div>
      <div class="row" style="gap:8px;justify-content:flex-end">
        <button class="btn-danger" data-act="remove">Remove</button>
      </div>
    </div>

    <div class="grid3" style="margin-top:10px">
      <div>
        <label>Name</label>
        <input data-k="name" type="text" value="${escapeAttr(s.name||"")}">
      </div>
      <div>
        <label>Order</label>
        <input data-k="order" type="number" value="${Number(s.order||0)}">
      </div>
      <div>
        <label>Set Time (Hour/Min)</label>
        <input data-k="ts" type="datetime-local" value="${defaultDate}">
      </div>
    </div>

    <div class="grid3" style="margin-top:10px">
      <div>
        <label>Status</label>
        <select data-k="status">
          <option value="operational" ${s.status==='operational'?'selected':''}>Operational</option>
          <option value="down">Down</option>
          <option value="degraded">Degraded</option>
          <option value="paused">Paused</option>
          <option value="maintenance">Maintenance</option>
        </select>
      </div>
      <div>
        <label>Version</label>
        <input data-k="version" type="text" placeholder="2.1.0">
      </div>
      <div>
        <label>Notes</label>
        <input data-k="notes" type="text" placeholder="Short notes">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn-primary" data-act="set">Set Status at Time</button>
      <button data-act="upd">Update Name/Order</button>
    </div>
  `;

  // --- ACTIONS ---
  wrap.querySelector('[data-act="remove"]').addEventListener("click", async ()=>{
    if(confirm(`Remove "${s.name}"?`)) await remove(ref(db, `services/${currentProjectId}/${s.id}`));
  });

  wrap.querySelector('[data-act="upd"]').addEventListener("click", async ()=>{
    const n = wrap.querySelector('input[data-k="name"]').value.trim();
    const o = Number(wrap.querySelector('input[data-k="order"]').value);
    await update(ref(db, `services/${currentProjectId}/${s.id}`), { name: n, order: o, lastUpdated: now() });
    toast("Info updated");
  });

  wrap.querySelector('[data-act="set"]').addEventListener("click", async ()=>{
    const tsStr = wrap.querySelector('input[data-k="ts"]').value; // "YYYY-MM-DDTHH:mm"
    if(!tsStr){ toast("Invalid Date"); return; }
    
    const status = wrap.querySelector('select[data-k="status"]').value;
    const version = wrap.querySelector('input[data-k="version"]').value.trim();
    const notes = wrap.querySelector('input[data-k="notes"]').value.trim();
    
    // UPDATED: Use the exact ISO string (sanitize dots if ms exist) as the key
    // This allows the status.html to sort events by time accurately.
    // Also store integer timestamp for easier sorting logic if needed.
    const key = tsStr.replace(/[.]/g, '_'); 
    const timestampObj = new Date(tsStr).getTime();

    const payload = { status, timestamp: timestampObj };
    if(version) payload.version = version;
    if(notes) payload.notes = notes;

    const updates = {};
    updates[`services/${currentProjectId}/${s.id}/history/${key}`] = payload;
    updates[`services/${currentProjectId}/${s.id}/lastUpdated`] = now();
    
    await update(ref(db), updates);
    toast("Status updated (auto-flows forward)");
  });

  return wrap;
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

$("#btnAddService").addEventListener("click", async ()=>{
  requireProject();
  if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
  const name = $("#newServiceName").value.trim();
  const order = Number($("#newServiceOrder").value||0);
  if(!name){ toast("Service name required"); return; }
  const sid = push(ref(db, `services/${currentProjectId}`)).key;
  await set(ref(db, `services/${currentProjectId}/${sid}`), { name, order, lastUpdated: now(), history: {} });
  $("#newServiceName").value = "";
  toast("Service added");
});

$("#btnImportLegacy").addEventListener("click", async ()=>{
  requireProject();
  if(!confirm("Import legacy statusApps?")) return;
  const snap = await get(ref(db, "statusApps"));
  const arr = snap.val() || [];
  if(!Array.isArray(arr) || !arr.length){ toast("No legacy data found"); return; }
  const updates = {};
  arr.forEach(app => {
    const id = push(ref(db, `services/${currentProjectId}`)).key;
    updates[`services/${currentProjectId}/${id}`] = {
      name: app.name || "Imported",
      order: 0, lastUpdated: now(), history: app.history || {}
    };
  });
  await update(ref(db), updates);
  toast("Imported");
});
</script>
</body>
</html>