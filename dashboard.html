<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>uptrace.lol - Status Dashboard</title>
<style>
  :root{
    --bg:#0d1117;--card:#161b22;--border:#30363d;--text:#c9d1d9;--sub:#8b949e;
    --accent:#58a6ff;--danger:#d2344e;--ok:#00c17c;
    --radius:14px;
    --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  }
  body{font-family:var(--font);background:var(--bg);color:var(--text);padding:24px;max-width:980px;margin:auto}
  h1{margin:0 0 6px 0;font-size:20px}
  .sub{color:var(--sub);font-size:13px;margin-bottom:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
  .card h2{margin:0 0 12px 0;font-size:16px}
  input,select,textarea{
    padding:8px 10px;border-radius:10px;border:1px solid var(--border);
    background:#0b0f14;color:var(--text);font-size:14px;width:100%;box-sizing:border-box
  }
  textarea{resize:vertical;min-height:88px}
  label{font-weight:700;display:block;margin:10px 0 6px}
  button{
    padding:9px 12px;border-radius:10px;border:1px solid var(--border);
    background:#202636;color:var(--text);font-weight:700;cursor:pointer
  }
  button:hover{border-color:var(--accent)}
  .btn-primary{background:#1f3b66;border-color:#274b82}
  .btn-danger{background:#3a1820;border-color:#5c1f2c;color:#ffd6dc}
  .btn-ghost{background:transparent}
  .pill{display:inline-flex;gap:10px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;color:var(--sub)}
  .muted{color:var(--sub)}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){.split{grid-template-columns:1fr}}
  .service{border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}
  .service-header{display:flex;justify-content:space-between;gap:10px;align-items:center}
  .service-name{font-weight:800}
  .hr{height:1px;background:var(--border);margin:14px 0}
  .toast{position:fixed;right:18px;bottom:18px;background:#0b0f14;border:1px solid var(--border);border-radius:12px;padding:12px 14px;opacity:0;transform:translateY(8px);transition:.18s}
  .toast.show{opacity:1;transform:none}
  .grid3{display:grid;grid-template-columns:1.1fr .9fr 1fr;gap:10px}
  @media(max-width:900px){.grid3{grid-template-columns:1fr}}
  code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
</style>
</head>
<body>

<h1>Status Dashboard</h1>
<div class="sub">Login → create a project → add services → publish a public status page.</div>

<div id="toast" class="toast"></div>

<!-- AUTH -->
<div id="authCard" class="card">
  <h2>Login / Register</h2>
  <div class="row">
    <div style="flex:1;min-width:240px">
      <label>Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email">
    </div>
    <div style="flex:1;min-width:240px">
      <label>Password</label>
      <input id="password" type="password" placeholder="••••••••" autocomplete="current-password">
    </div>
  </div>
  <div class="row" style="margin-top:12px">
    <button class="btn-primary" id="btnLogin">Login</button>
    <button id="btnRegister">Register</button>
  </div>
  <div class="muted" style="margin-top:10px">
    Tip: Buy us a coffee. Its NOT free! Thanks!11
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:12px">
    <div class="pill">
      <span>Signed in as</span>
      <code id="userEmail">—</code>
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <button class="btn-ghost" id="btnAccount">Account</button>
      <button class="btn-ghost" id="btnLogout">Logout</button>
    </div>
  </div>

  <!-- ACCOUNT (integrated, no new page) -->
  <div id="accountCard" class="card" style="margin-bottom:12px;display:none">
    <h2>Account</h2>

    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="pill">
        <span>UID</span>
        <code id="userUid">—</code>
      </div>
      <div class="pill">
        <span>Email verified</span>
        <code id="emailVerified">—</code>
      </div>
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <label>Username (optional)</label>
        <input id="username" type="text" placeholder="noxy" maxlength="24">
        <div class="row" style="margin-top:10px">
          <button class="btn-primary" id="btnSaveUsername">Save username</button>
        </div>
        <div class="muted" style="margin-top:8px">
          Stored in Realtime DB at <code>users/&lt;uid&gt;/profile</code>.
        </div>
      </div>

      <div>
        <label>Verify your email</label>
        <div class="row" style="margin-top:6px">
          <button id="btnSendVerify" class="btn-primary">Send verification email</button>
          <button id="btnRefreshUser">Refresh status</button>
        </div>

        <div class="hr"></div>

        <label>Change email</label>
        <input id="newEmail" type="email" placeholder="new@email.com">
        <div class="row" style="margin-top:10px">
          <button id="btnChangeEmail" class="btn-primary">Change email</button>
        </div>

        <div class="hr"></div>

        <label>Change password</label>
        <input id="newPassword" type="password" placeholder="New password (6+ chars)">
        <div class="row" style="margin-top:10px">
          <button id="btnChangePassword" class="btn-primary">Change password</button>
        </div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="row" style="align-items:center;justify-content:space-between">
      <div>
        <div style="font-weight:800">Export all data</div>
        <div class="muted">Downloads a JSON containing your projects and their data (based on access).</div>
      </div>
      <button id="btnExportData">Export JSON</button>
    </div>

    <div class="hr"></div>

    <div class="row" style="align-items:center;justify-content:space-between">
      <div>
        <div style="font-weight:800;color:#ffd6dc">Account deletion</div>
        <div class="muted">No servers here: you can request deletion (flag) or delete instantly.</div>
      </div>
      <button class="btn-danger" id="btnDeleteAccount">Delete instantly</button>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn-ghost" id="btnRequestDeletion">Request deletion (store flag)</button>
    </div>

    <div class="muted" style="margin-top:8px">
      Note: A true "delete in 3 days automatically" requires a backend/Cloud Function. This page can only store the request time.
    </div>
  </div>

  <div class="split">
    <!-- Projects -->
    <div class="card">
      <h2>Projects</h2>

      <label>Your projects</label>
      <select id="projectSelect"></select>

      <div class="row" style="margin-top:10px">
        <button id="btnCreateProject" class="btn-primary">+ Create project</button>
        <button id="btnOpenPublic">Open public page</button>
      </div>

      <div class="hr"></div>

      <label>Project name</label>
      <input id="projectName" type="text" placeholder="My API / My App">

      <label>Project slug (public URL)</label>
      <input id="projectSlug" type="text" placeholder="my-api" maxlength="40">

      <div class="row" style="margin-top:10px;align-items:center">
        <label style="margin:0;display:flex;gap:8px;align-items:center;font-weight:700">
          <input id="projectPublic" type="checkbox" style="width:auto">
          Public
        </label>
        <span class="muted">If off, only members can view status.</span>
      </div>

      <div class="row" style="margin-top:12px">
        <button id="btnSaveProject" class="btn-primary">Save project</button>
      </div>

      <div class="muted" style="margin-top:12px">
        Public URL will be: <code>status.html?project=&lt;slug&gt;</code>
      </div>
    </div>

    <!-- Announcement -->
    <div class="card">
      <h2>Announcement</h2>
      <label>General announcement text</label>
      <textarea id="announcement" placeholder="Maintenance window, incident update, etc."></textarea>
      <div class="row" style="margin-top:10px">
        <button id="btnSaveAnnouncement" class="btn-primary">Save announcement</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2>Services</h2>

    <div class="row">
      <div style="flex:1;min-width:240px">
        <label>New service name</label>
        <input id="newServiceName" type="text" placeholder="API, Website, Auth, Payments…">
      </div>
      <div style="width:180px;min-width:160px">
        <label>Order</label>
        <input id="newServiceOrder" type="number" value="0">
      </div>
      <div style="align-self:flex-end">
        <button id="btnAddService" class="btn-primary">Add service</button>
      </div>
    </div>

    <div class="hr"></div>

    <div id="services"></div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2>Legacy import (optional)</h2>
    <div class="muted">
      If you previously used <code>statusApps</code> at the DB root, you can import it into the selected project once.
      This does NOT delete the old data.
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnImportLegacy">Import legacy statusApps → services</button>
    </div>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut,
  sendEmailVerification,
  updateEmail,
  updatePassword,
  deleteUser,
  EmailAuthProvider,
  reauthenticateWithCredential,
  verifyBeforeUpdateEmail
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import {
  ref, get, set, update, push, remove, onValue, child
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const $ = (q)=>document.querySelector(q);

function toast(msg){
  const el = $("#toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 2400);
}

function slugify(s){
  return String(s||"")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g,'-')
    .replace(/^-+|-+$/g,'')
    .slice(0,40);
}

function now(){ return Date.now(); }

let currentUid = null;
let currentProjectId = null;
let currentRole = null;
let servicesUnsub = null;
let projectUnsub = null;

async function getRole(projectId, uid){
  const snap = await get(ref(db, `projectMembers/${projectId}/${uid}/role`));
  return snap.val() || null;
}

function requireProject(){
  if(!currentProjectId) throw new Error("Pick a project first.");
}

/* ---------------- ACCOUNT HELPERS ---------------- */
async function promptReauth(user){
  if(!user?.email) throw new Error("Re-auth requires an email/password account.");
  const pass = prompt("For security, re-enter your current password:");
  if(!pass) throw new Error("Re-auth cancelled");
  const cred = EmailAuthProvider.credential(user.email, pass);
  await reauthenticateWithCredential(user, cred);
}

function downloadJson(filename, obj){
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ---------------- AUTH UI ---------------- */
$("#btnRegister").addEventListener("click", async ()=>{
  const email = $("#email").value.trim();
  const pass  = $("#password").value;
  if(!email || pass.length<6){ toast("Email + password (6+ chars)"); return; }
  try{
    await createUserWithEmailAndPassword(auth, email, pass);
    toast("Registered!");
  }catch(e){
    toast(e.message);
  }
});

$("#btnLogin").addEventListener("click", async ()=>{
  const email = $("#email").value.trim();
  const pass  = $("#password").value;
  if(!email || !pass){ toast("Enter email + password"); return; }
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    toast("Logged in!");
  }catch(e){
    toast(e.message);
  }
});


$("#btnAccount").addEventListener("click", ()=>{
  const card = $("#accountCard");
  if(!card) return;
  const shown = card.style.display !== "none";
  card.style.display = shown ? "none" : "block";
});
$("#btnLogout").addEventListener("click", async ()=>{
  await signOut(auth);
});

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    currentUid = null;
    currentProjectId = null;
    currentRole = null;
    $("#authCard").style.display = "block";
    $("#app").style.display = "none";
    return;
  }
  currentUid = user.uid;
  $("#userEmail").textContent = user.email || user.uid;

  // Account header fields
  $("#userUid").textContent = user.uid;
  $("#emailVerified").textContent = user.emailVerified ? "yes" : "no";

  // Ensure user profile exists (best-effort; requires rules for users/$uid)
  try{
    const profSnap = await get(ref(db, `users/${user.uid}/profile`));
    const prof = profSnap.val() || {};
    $("#username").value = prof.username || "";
    if(!prof.createdAt){
      await update(ref(db, `users/${user.uid}/profile`), { createdAt: now() });
    }
  }catch(_){
    // If you didn't add rules for users/$uid yet, dashboard still works.
  }

  $("#authCard").style.display = "none";
  $("#app").style.display = "block";

  await loadProjects();
});

/* ---------------- ACCOUNT ACTIONS ---------------- */
$("#btnRefreshUser").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  try{
    await user.reload();
    $("#userEmail").textContent = user.email || user.uid;
    $("#userUid").textContent = user.uid;
    $("#emailVerified").textContent = user.emailVerified ? "yes" : "no";
    toast("Refreshed");
  }catch(e){
    toast(e.message);
  }
});

$("#btnSendVerify").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  try{
    await sendEmailVerification(user);
    toast("Verification email sent");
  }catch(e){
    toast(e.message);
  }
});

$("#btnSaveUsername").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  const username = ($("#username").value || "").trim();

  if(username.length > 24){ toast("Username max 24 chars"); return; }
  if(username && !/^[a-zA-Z0-9_.-]{3,24}$/.test(username)){
    toast("Use 3-24 chars: letters, numbers, _ . -");
    return;
  }

  try{
    await update(ref(db, `users/${user.uid}/profile`), { username });
    toast("Username saved");
  }catch(e){
    toast(e.message);
  }
});

$("#btnChangeEmail").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  const newEmail = ($("#newEmail").value || "").trim();
  if(!newEmail){ toast("Enter new email"); return; }

  // IMPORTANT:
  // Many Firebase projects now require verifying the NEW email before the change completes.
  // Using verifyBeforeUpdateEmail sends a confirmation link to the new email and only then updates the account.
  try{
    await verifyBeforeUpdateEmail(user, newEmail);
    toast("Check your NEW email to confirm the change");
    $("#newEmail").value = "";
  }catch(e){
    if(String(e.code||"").includes("requires-recent-login")){
      try{
        await promptReauth(user);
        await verifyBeforeUpdateEmail(user, newEmail);
        toast("Check your NEW email to confirm the change");
        $("#newEmail").value = "";
      }catch(e2){
        toast(e2.message || String(e2));
      }
    }else{
      toast(e.message);
    }
  }
});

$("#btnChangePassword")).addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  const newPass = ($("#newPassword").value || "");
  if(!newPass || newPass.length < 6){ toast("Password must be 6+ chars"); return; }

  try{
    await updatePassword(user, newPass);
    toast("Password updated");
    $("#newPassword").value = "";
  }catch(e){
    if(String(e.code||"").includes("requires-recent-login")){
      try{
        await promptReauth(user);
        await updatePassword(user, newPass);
        toast("Password updated");
        $("#newPassword").value = "";
      }catch(e2){
        toast(e2.message || String(e2));
      }
    }else{
      toast(e.message);
    }
  }
});

$("#btnRequestDeletion").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  try{
    await update(ref(db, `users/${user.uid}/profile`), { deletionRequestedAt: now() });
    toast("Deletion request stored");
  }catch(e){
    toast(e.message);
  }
});

$("#btnDeleteAccount").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;

  const ok = confirm("This will DELETE your Firebase Auth account instantly. Continue?");
  if(!ok) return;

  try{
    // Optional: store flag before deletion (best effort)
    try{ await update(ref(db, `users/${user.uid}/profile`), { deletionRequestedAt: now() }); }catch(_){}

    await deleteUser(user);
    toast("Account deleted");
  }catch(e){
    if(String(e.code||"").includes("requires-recent-login")){
      try{
        await promptReauth(user);
        await deleteUser(user);
        toast("Account deleted");
      }catch(e2){
        toast(e2.message || String(e2));
      }
    }else{
      toast(e.message);
    }
  }
});

$("#btnExportData").addEventListener("click", async ()=>{
  const user = auth.currentUser;
  if(!user) return;

  try{
    const up = await get(ref(db, `userProjects/${user.uid}`));
    const map = up.val() || {};
    const projectIds = Object.keys(map);

    const out = {
      exportedAt: new Date().toISOString(),
      uid: user.uid,
      email: user.email,
      emailVerified: !!user.emailVerified,
      profile: {},
      projects: {}
    };

    // best-effort profile export
    try{
      out.profile = (await get(ref(db, `users/${user.uid}/profile`))).val() || {};
    }catch(_){}

    for(const pid of projectIds){
      const p = (await get(ref(db, `projects/${pid}`))).val();
      if(!p) continue;

      const role = (await get(ref(db, `projectMembers/${pid}/${user.uid}/role`))).val();
      const data = { meta: p, yourRole: role || null };

      data.services = (await get(ref(db, `services/${pid}`))).val() || {};
      data.announcements = (await get(ref(db, `announcements/${pid}`))).val() || {};
      data.incidents = (await get(ref(db, `incidents/${pid}`))).val() || {};
      data.members = (await get(ref(db, `projectMembers/${pid}`))).val() || {};

      out.projects[pid] = data;
    }

    downloadJson(`ezstatus-export-${user.uid}.json`, out);
    toast("Exported");
  }catch(e){
    toast(e.message);
  }
});

/* ---------------- PROJECTS ---------------- */
async function loadProjects(){
  // userProjects/{uid}/{projectId}: true  (fast listing)
  const snap = await get(ref(db, `userProjects/${currentUid}`));
  const map = snap.val() || {};
  const ids = Object.keys(map);

  const sel = $("#projectSelect");
  sel.innerHTML = "";
  if(ids.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No projects (create one)";
    sel.appendChild(opt);
    currentProjectId = null;
    return;
  }

  for(const id of ids){
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = id;
    sel.appendChild(opt);
  }

  sel.value = ids[0];
  await selectProject(ids[0]);
}

$("#projectSelect").addEventListener("change", async ()=>{
  const id = $("#projectSelect").value;
  if(id) await selectProject(id);
});

async function selectProject(projectId){
  currentProjectId = projectId;
  currentRole = await getRole(projectId, currentUid);
  if(!currentRole){
    toast("No access to this project.");
    return;
  }

  // Live project meta
  if(projectUnsub) projectUnsub();
  projectUnsub = onValue(ref(db, `projects/${projectId}`), snap=>{
    const p = snap.val() || {};
    $("#projectName").value = p.name || "";
    $("#projectSlug").value = p.slug || "";
    $("#projectPublic").checked = !!p.public;
  });

  // Live services list
  mountServicesListener();
  // Load announcement
  onValue(ref(db, `announcements/${projectId}`), snap=>{
    const v = snap.val() || {};
    $("#announcement").value = v.text || "";
  }, { onlyOnce: false });

  toast(`Project selected (${currentRole})`);
}

$("#btnCreateProject").addEventListener("click", async ()=>{
  const name = prompt("Project name?");
  if(!name) return;

  const slug = slugify(name);
  if(!/^[a-z0-9-]{3,40}$/.test(slug)){ toast("Slug invalid"); return; }

  try{
    // 1) create project
    const projectId = push(ref(db, "projects")).key;
    await set(ref(db, `projects/${projectId}`), {
      name,
      slug,
      ownerUid: currentUid,
      public: true,
      createdAt: now()
    });

    // 2) create membership (bootstrap)
    await set(ref(db, `projectMembers/${projectId}/${currentUid}`), { role: "owner" });

    // 3) add project to user's list
    await set(ref(db, `userProjects/${currentUid}/${projectId}`), true);

    // 4) slug index
    await set(ref(db, `projectSlugs/${slug}`), projectId);

    toast("Project created");
    await loadProjects();
    $("#projectSelect").value = projectId;
    await selectProject(projectId);

  }catch(e){
    toast(e.message);
  }
});


$("#btnSaveProject").addEventListener("click", async ()=>{
  try{
    requireProject();
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }

    const name = $("#projectName").value.trim();
    let slug = slugify($("#projectSlug").value);
    const isPublic = $("#projectPublic").checked;

    if(!name){ toast("Name required"); return; }
    if(!/^[a-z0-9-]{3,40}$/.test(slug)){ toast("Slug must be 3-40 chars a-z 0-9 -"); return; }

    // Enforce unique slug via projectSlugs index
    // If slug already points to another project -> reject
    const idxSnap = await get(ref(db, `projectSlugs/${slug}`));
    const existing = idxSnap.val();
    if(existing && existing !== currentProjectId){
      toast("Slug already used");
      return;
    }

    // Also clean up old slug index if slug changed
    const oldSnap = await get(ref(db, `projects/${currentProjectId}/slug`));
    const oldSlug = oldSnap.val();
    const updates = {};
    updates[`projects/${currentProjectId}/name`] = name;
    updates[`projects/${currentProjectId}/slug`] = slug;
    updates[`projects/${currentProjectId}/public`] = isPublic;

    if(oldSlug && oldSlug !== slug){
      updates[`projectSlugs/${oldSlug}`] = null;
    }
    updates[`projectSlugs/${slug}`] = currentProjectId;

    await update(ref(db), updates);
    toast("Saved");
  }catch(e){
    toast(e.message);
  }
});

$("#btnOpenPublic").addEventListener("click", async ()=>{
  try{
    requireProject();
    const snap = await get(ref(db, `projects/${currentProjectId}/slug`));
    const slug = snap.val();
    if(!slug){ toast("Set a slug first"); return; }
    // You had `status?project=...` before; that would 404 on GitHub Pages.
    // This keeps behavior but uses the correct file name.
    window.open(`status.html?project=${encodeURIComponent(slug)}`, "_blank");
  }catch(e){
    toast(e.message);
  }
});

/* ---------------- ANNOUNCEMENT ---------------- */
$("#btnSaveAnnouncement").addEventListener("click", async ()=>{
  try{
    requireProject();
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }

    const text = $("#announcement").value;
    await set(ref(db, `announcements/${currentProjectId}`), { text, updatedAt: now() });
    toast("Announcement saved");
  }catch(e){
    toast(e.message);
  }
});

/* ---------------- SERVICES ---------------- */
function mountServicesListener(){
  const holder = $("#services");
  onValue(ref(db, `services/${currentProjectId}`), snap=>{
    const services = snap.val() || {};
    const entries = Object.entries(services)
      .map(([id,s])=>({id,...s}))
      .sort((a,b)=>(a.order??0)-(b.order??0));

    holder.innerHTML = "";
    if(entries.length===0){
      holder.innerHTML = `<div class="muted">No services yet. Add one above.</div>`;
      return;
    }

    for(const s of entries){
      holder.appendChild(renderServiceCard(s));
    }
  });
}

function statusOptions(selected){
  const opts = [
    ["operational","Operational (Online)"],
    ["down","Down (Offline)"],
    ["degraded","Degraded Performance"],
    ["paused","Paused"],
    ["maintenance","Maintenance"],
    ["unknown","Unknown"],
    ["unlinked","Unlinked"]
  ];
  return opts.map(([v,l])=>`<option value="${v}" ${v===selected?'selected':''}>${l}</option>`).join("");
}

function renderServiceCard(s){
  const wrap = document.createElement("div");
  wrap.className = "service";
  wrap.innerHTML = `
    <div class="service-header">
      <div>
        <div class="service-name">${escapeHtml(s.name||"Unnamed")}</div>
        <div class="muted">id: <code>${s.id}</code></div>
      </div>
      <div class="row" style="gap:8px;justify-content:flex-end">
        <button class="btn-danger" data-act="remove">Remove</button>
      </div>
    </div>

    <div class="grid3" style="margin-top:10px">
      <div>
        <label>Name</label>
        <input data-k="name" type="text" value="${escapeAttr(s.name||"")}">
      </div>
      <div>
        <label>Order</label>
        <input data-k="order" type="number" value="${Number(s.order||0)}">
      </div>
      <div>
        <label>Set status for date</label>
        <input data-k="date" type="date" value="${new Date().toISOString().split("T")[0]}">
      </div>
    </div>

    <div class="grid3" style="margin-top:10px">
      <div>
        <label>Status</label>
        <select data-k="status">${statusOptions("operational")}</select>
      </div>
      <div>
        <label>Version</label>
        <input data-k="version" type="text" placeholder="2.1.0">
      </div>
      <div>
        <label>Notes</label>
        <input data-k="notes" type="text" placeholder="Short notes (optional)">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn-primary" data-act="setDate">Save for this date</button>
      <button data-act="bulk14">Set same status for last 14 days</button>
    </div>
  `;

  const actRemove = wrap.querySelector('[data-act="remove"]');
  const actSet    = wrap.querySelector('[data-act="setDate"]');
  const actBulk   = wrap.querySelector('[data-act="bulk14"]');
  const nameInput = wrap.querySelector('input[data-k="name"]');
  const orderInput= wrap.querySelector('input[data-k="order"]');

  actRemove.addEventListener("click", async ()=>{
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
    if(!confirm(`Remove "${s.name}"?`)) return;
    await remove(ref(db, `services/${currentProjectId}/${s.id}`));
    toast("Removed");
  });

  nameInput.addEventListener("change", async ()=>{
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
    await update(ref(db, `services/${currentProjectId}/${s.id}`), { name: nameInput.value.trim(), lastUpdated: now() });
    toast("Saved");
  });

  orderInput.addEventListener("change", async ()=>{
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
    await update(ref(db, `services/${currentProjectId}/${s.id}`), { order: Number(orderInput.value||0), lastUpdated: now() });
    toast("Saved");
  });

  actSet.addEventListener("click", async ()=>{
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
    const date = wrap.querySelector('input[data-k="date"]').value;
    const status = wrap.querySelector('select[data-k="status"]').value;
    const version = wrap.querySelector('input[data-k="version"]').value.trim();
    const notes = wrap.querySelector('input[data-k="notes"]').value.trim();

    const payload = { status, timestamp: now() };
    if(version) payload.version = version;
    if(notes) payload.notes = notes;

    const updates = {};
    updates[`services/${currentProjectId}/${s.id}/history/${date}`] = payload;
    updates[`services/${currentProjectId}/${s.id}/lastUpdated`] = now();
    await update(ref(db), updates);
    toast("Saved date");
  });

  actBulk.addEventListener("click", async ()=>{
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
    const status = wrap.querySelector('select[data-k="status"]').value;
    if(!confirm(`Set "${status}" for last 14 days?`)) return;

    const updates = {};
    for(let i=13;i>=0;i--){
      const d = new Date();
      d.setDate(d.getDate()-i);
      const ds = d.toISOString().split("T")[0];
      updates[`services/${currentProjectId}/${s.id}/history/${ds}`] = { status, timestamp: now() };
    }
    updates[`services/${currentProjectId}/${s.id}/lastUpdated`] = now();
    await update(ref(db), updates);
    toast("Bulk saved");
  });

  return wrap;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

$("#btnAddService").addEventListener("click", async ()=>{
  try{
    requireProject();
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
    const name = $("#newServiceName").value.trim();
    const order = Number($("#newServiceOrder").value||0);
    if(!name){ toast("Service name required"); return; }

    const serviceId = push(ref(db, `services/${currentProjectId}`)).key;
    await set(ref(db, `services/${currentProjectId}/${serviceId}`), {
      name, order, lastUpdated: now(), history: {}
    });
    $("#newServiceName").value = "";
    toast("Service added");
  }catch(e){ toast(e.message); }
});

/* ---------------- LEGACY IMPORT ---------------- */
$("#btnImportLegacy").addEventListener("click", async ()=>{
  try{
    requireProject();
    if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
    if(!confirm("Import legacy statusApps from DB root into this project?")) return;

    const legacySnap = await get(ref(db, "statusApps"));
    const legacy = legacySnap.val() || [];
    if(!Array.isArray(legacy) || legacy.length===0){ toast("No legacy array found"); return; }

    const updates = {};
    legacy.forEach((app)=>{
      const id = push(ref(db, `services/${currentProjectId}`)).key;
      updates[`services/${currentProjectId}/${id}`] = {
        name: app.name || "Imported",
        order: 0,
        lastUpdated: app.lastUpdated || now(),
        history: app.history || {}
      };
    });
    await update(ref(db), updates);
    toast("Imported");
  }catch(e){ toast(e.message); }
});
</script>

</body>
</html>
