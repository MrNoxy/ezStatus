<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UpTrace - Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Kode+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121010;
            --card-bg: #141212;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --accent-red: #e66e6e;
            --accent-blue: #0099ff;
            --input-bg: rgba(187, 187, 187, 0.15);
            --input-border: rgba(136, 136, 136, 0.1);
            --border-radius: 13px;
            --font-head: "Kode Mono", monospace;
            --font-body: "Inter", sans-serif;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 14px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Ambient Background Effects --- */
        .ambient-glow {
            position: fixed;
            width: 500px;
            height: 500px;
            background: radial-gradient(50% 50%, rgba(255, 51, 51, 0.15) 0%, rgba(138, 0, 0, 0) 100%);
            filter: blur(80px);
            z-index: -1;
            pointer-events: none;
        }
        .glow-1 { top: -150px; left: -150px; }
        .glow-2 { bottom: -150px; right: -150px; }
        .glow-3 { top: 40%; left: 30%; width: 300px; height: 300px; opacity: 0.5; }

        /* --- Typography --- */
        h1, h2, h3 { font-family: var(--font-head); font-weight: 400; margin: 0; }
        h1 { font-size: 24px; color: var(--accent-red); margin-bottom: 5px; }
        h2 { font-size: 18px; margin-bottom: 15px; color: white; }
        .sub-text { color: var(--text-secondary); font-weight: 300; font-size: 13px; margin-bottom: 20px; }
        code { font-family: var(--font-head); background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 4px; color: var(--accent-blue); }

        /* --- Layout --- */
        .layout-container {
            display: flex;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        .sidebar {
            width: 260px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .layout-container { flex-direction: column; }
            .sidebar { width: 100%; }
        }

        /* --- Components --- */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }

        .menu-btn {
            background-color: transparent;
            color: var(--text-secondary);
            border: 1px solid transparent;
            padding: 12px 15px;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            font-size: 13px;
        }
        .menu-btn:hover { background: rgba(255,255,255,0.03); color: white; }
        .menu-btn.active { background: rgba(230, 110, 110, 0.1); color: var(--accent-red); border: 1px solid rgba(230, 110, 110, 0.2); }

        /* --- CUSTOM DROPDOWN STYLING --- */
        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
            margin-bottom: 15px;
        }
        .custom-select-trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            font-size: 14px;
            font-weight: 400;
            color: #fff;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-select-trigger:hover {
            background: rgba(187, 187, 187, 0.2);
        }
        .custom-select-trigger:after {
            content: '▼';
            font-size: 10px;
            color: var(--text-secondary);
        }
        .custom-options {
            position: absolute;
            display: block;
            top: 110%;
            left: 0;
            right: 0;
            border: 1px solid var(--input-border);
            border-radius: 10px;
            background: #1a1818;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            z-index: 100;
            transform: translateY(-10px);
            transition: all 0.2s;
            max-height: 200px;
            overflow-y: auto;
        }
        .custom-select-wrapper.open .custom-options {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
            transform: translateY(0);
        }
        .custom-option {
            position: relative;
            display: block;
            padding: 10px 15px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-option:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
        }
        .custom-option.selected {
            color: var(--accent-blue);
            background: rgba(0, 153, 255, 0.1);
        }

        /* --- Form Elements --- */
        label {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 8px;
            margin-top: 15px;
            font-weight: 300;
        }

        input, select, textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 14px;
            transition: 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-blue);
            background: rgba(0, 153, 255, 0.05);
        }
        
        input::placeholder, textarea::placeholder { color: #555; }

        /* --- Buttons --- */
        .btn-primary, .btn-danger, .btn-ghost {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid rgba(230, 110, 110, 0.1);
            background: rgba(230, 110, 110, 0.05);
            color: white;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: rgba(230, 110, 110, 0.15);
            border-color: rgba(230, 110, 110, 0.3);
            transform: translateY(-1px);
        }

        .btn-danger {
            border-color: rgba(255, 50, 50, 0.2);
            background: rgba(255, 50, 50, 0.05);
            color: #ffaaaa;
        }
        .btn-danger:hover { background: rgba(255, 50, 50, 0.15); }

        .btn-ghost {
            background: transparent;
            border-color: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover { color: white; }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* --- Auth Screen Centering --- */
        #authCard {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }

        /* --- Service Items --- */
        .service-item {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        @media(max-width: 768px) { .grid-3 { grid-template-columns: 1fr; } }

        /* --- Toast --- */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1a1a1a;
            border: 1px solid var(--accent-blue);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            opacity: 0;
            transform: translateY(20px);
            transition: 0.3s;
            z-index: 1000;
            font-family: var(--font-head);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .separator {
            height: 1px;
            background: rgba(255,255,255,0.05);
            width: 100%;
            margin: 25px 0;
        }

        .badge {
            background: rgba(0, 153, 255, 0.1);
            color: var(--accent-blue);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: var(--font-head);
        }
    </style>
</head>
<body>

    <div class="ambient-glow glow-1"></div>
    <div class="ambient-glow glow-2"></div>
    <div class="ambient-glow glow-3"></div>
    <div id="toast" class="toast">Action Successful</div>

    <div id="authCard" class="card" style="display:none;">
        <h1>UpTrace</h1>
        <p class="sub-text">Trace your status for free. Login to continue.</p>
        
        <div style="text-align: left;">
            <label>Email</label>
            <input id="email" type="email" placeholder="you@example.com" autocomplete="email">
            
            <label>Password</label>
            <input id="password" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>

        <div class="btn-row" style="justify-content: center;">
            <button class="btn-primary" id="btnLogin">Login</button>
            <button class="btn-ghost" id="btnRegister">Register</button>
        </div>
    </div>

    <div id="app" class="layout-container" style="display:none;">
        
        <div class="sidebar">
            <div class="card" style="padding: 20px;">
                <h1 style="font-size: 20px;">UpTrace</h1>
                <div class="badge" id="userEmail">Loading...</div>
                
                <div class="separator" style="margin: 15px 0;"></div>

                <label style="margin-top:0;">Current Project</label>
                
                <div class="custom-select-wrapper" id="projectSelectWrapper">
                    <div class="custom-select-trigger">
                        <span id="projectSelectLabel">Select Project</span>
                    </div>
                    <div class="custom-options" id="projectSelectOptions">
                        </div>
                </div>

                <button id="btnCreateProject" class="btn-ghost" style="width:100%; justify-content: flex-start; padding-left:0;">+ New Project</button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button class="menu-btn active" id="btnNavDashboard">
                    <span style="width:10px; height:10px; background:var(--accent-red); border-radius:50%; display:inline-block; margin-right:5px;"></span>
                    Dashboard
                </button>
                <button class="menu-btn" id="btnAccount">
                    Manage Account
                </button>
                <a href="https://discord.gg/r5SyNyCYjb" target="_blank" class="menu-btn">Discord Community</a>
                <button class="menu-btn" id="btnLogout" style="margin-top: 10px; color: #e66e6e;">Logout</button>
            </div>
        </div>

        <div class="main-content">
            
            <div id="accountCard" class="card" style="display:none;">
                <h2>Account Settings</h2>
                <div class="grid-3">
                    <div>
                        <label>UID</label>
                        <code id="userUid" style="display:block; margin-top:5px; word-break: break-all;">...</code>
                    </div>
                    <div>
                        <label>Verified</label>
                        <code id="emailVerified">...</code>
                    </div>
                </div>

                <div class="separator"></div>

                <div class="grid-3">
                    <div>
                        <label>Username</label>
                        <input id="username" type="text" placeholder="username">
                        <button class="btn-primary" id="btnSaveUsername" style="margin-top:10px; width:100%">Save</button>
                    </div>
                    <div>
                        <label>Change Email</label>
                        <input id="newEmail" type="email" placeholder="new@email.com">
                        <button id="btnChangeEmail" class="btn-primary" style="margin-top:10px; width:100%">Update</button>
                    </div>
                    <div>
                        <label>Change Password</label>
                        <input id="newPassword" type="password" placeholder="New Password">
                        <button id="btnChangePassword" class="btn-primary" style="margin-top:10px; width:100%">Update</button>
                    </div>
                </div>

                <div class="separator"></div>
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="color:white; font-weight:500">Data & Privacy</div>
                        <div class="sub-text" style="margin:0">Manage your data export or deletion.</div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button id="btnExportData" class="btn-ghost">Export JSON</button>
                        <button id="btnDeleteAccount" class="btn-danger">Delete Account</button>
                        <button id="btnRequestDeletion" style="display:none"></button> 
                        <button id="btnSendVerify" style="display:none"></button> 
                        <button id="btnRefreshUser" style="display:none"></button> 
                    </div>
                </div>
            </div>

            <div id="dashboardView">
                
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <h2>Project Settings</h2>
                        <button id="btnOpenPublic" class="btn-primary">View Public Page ↗</button>
                    </div>

                    <div class="grid-3">
                        <div>
                            <label>Project Name</label>
                            <input id="projectName" type="text" placeholder="My App Status">
                        </div>
                        <div>
                            <label>Slug (URL)</label>
                            <input id="projectSlug" type="text" placeholder="my-app">
                        </div>
                        <div>
                            <label>Visibility</label>
                            <div style="margin-top:12px; display:flex; align-items:center; gap:10px; color:var(--text-secondary);">
                                <input id="projectPublic" type="checkbox" style="width:auto; margin:0;">
                                <span>Publicly Visible</span>
                            </div>
                        </div>
                    </div>

                    <div class="btn-row" style="justify-content: space-between;">
                        <button id="btnSaveProject" class="btn-primary">Save Settings</button>
                        <button id="btnDeleteProject" class="btn-danger">Delete Project</button>
                    </div>
                    <p class="sub-text" style="margin-top:15px;">Public URL: https://uptrace.lol/status.html?project=<span id="slugPreview">...</span></p>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>Announcement</h2>
                    <p class="sub-text">This message appears at the top of your public status page.</p>
                    <textarea id="announcement" placeholder="e.g. Scheduled maintenance this Sunday..." rows="3"></textarea>
                    <div class="btn-row">
                        <button id="btnSaveAnnouncement" class="btn-primary">Update Announcement</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>Services & Monitors</h2>
                    
                    <div style="background: rgba(255,255,255,0.03); padding:15px; border-radius:10px; margin-bottom:20px;">
                        <div class="grid-3" style="align-items: end;">
                            <div style="grid-column: span 2;">
                                <label>New Service Name</label>
                                <input id="newServiceName" type="text" placeholder="e.g. API Server, Database, Website">
                            </div>
                            <div style="display:none"><input id="newServiceOrder" value="0"></div> 
                            <button id="btnAddService" class="btn-primary" style="height: 42px;">+ Add Service</button>
                        </div>
                    </div>

                    <div id="services">
                        </div>
                </div>

                <div class="card" style="margin-top:20px; border-color: rgba(255,255,255,0.02);">
                    <h3 style="font-size:16px; color:#666;">Legacy Data</h3>
                    <p class="sub-text">Import statusApps from root DB (One-time action)</p>
                    <button id="btnImportLegacy" class="btn-ghost" style="border:1px solid #333;">Run Import</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ----------------------------------------------------
        // FIREBASE CONFIGURATION (PASTE YOUR KEYS HERE)
        // ----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // ----------------------------------------------------

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Import other Firebase functions
        import {
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          onAuthStateChanged,
          signOut,
          sendEmailVerification,
          updateEmail,
          updatePassword,
          deleteUser,
          EmailAuthProvider,
          reauthenticateWithCredential,
          verifyBeforeUpdateEmail
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import {
          ref, get, set, update, push, remove, onValue, child
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        
        const $ = (q)=>document.querySelector(q);
        function toast(msg){
          const el = $("#toast");
          el.textContent = msg;
          el.classList.add("show");
          setTimeout(()=>el.classList.remove("show"), 2400);
        }
        
        function slugify(s){
          return String(s||"")
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g,'-')
            .replace(/^-+|-+$/g,'')
            .slice(0,40);
        }
        
        function now(){ return Date.now(); }
        
        let currentUid = null;
        let currentProjectId = null;
        let currentRole = null;
        let servicesUnsub = null;
        let projectUnsub = null;
        
        async function getRole(projectId, uid){
          const snap = await get(ref(db, `projectMembers/${projectId}/${uid}/role`));
          return snap.val() || null;
        }
        
        function requireProject(){
          if(!currentProjectId) throw new Error("Pick a project first.");
        }

        // --- CUSTOM DROPDOWN LOGIC ---
        function setupCustomDropdown() {
            const wrapper = $('#projectSelectWrapper');
            const trigger = wrapper.querySelector('.custom-select-trigger');
            
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                wrapper.classList.toggle('open');
            });

            // Close when clicking outside
            window.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    wrapper.classList.remove('open');
                }
            });
        }
        setupCustomDropdown();

        function renderDropdown(projects) {
            const optionsContainer = $('#projectSelectOptions');
            const label = $('#projectSelectLabel');
            optionsContainer.innerHTML = '';

            if (projects.length === 0) {
                label.textContent = "No Projects";
                optionsContainer.innerHTML = '<span class="custom-option">No projects found</span>';
                return;
            }

            projects.forEach(p => {
                const opt = document.createElement('span');
                opt.className = 'custom-option';
                if(p.id === currentProjectId) opt.classList.add('selected');
                // Show Name and (ID)
                opt.innerHTML = `${escapeHtml(p.name)} <span style="font-size:10px; color:#555; margin-left:5px;">${p.id.substr(0,4)}...</span>`;
                
                opt.addEventListener('click', () => {
                    selectProject(p.id);
                    $('#projectSelectWrapper').classList.remove('open');
                });
                optionsContainer.appendChild(opt);
            });
        }
        
        /* ---------------- AUTH HELPERS ---------------- */
        async function promptReauth(user){
          if(!user?.email) throw new Error("Re-auth requires an email/password account.");
          const pass = prompt("For security, re-enter your current password:");
          if(!pass) throw new Error("Re-auth cancelled");
          const cred = EmailAuthProvider.credential(user.email, pass);
          await reauthenticateWithCredential(user, cred);
        }
        
        function downloadJson(filename, obj){
          const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
        
        /* ---------------- AUTH UI ---------------- */
        $("#btnRegister").addEventListener("click", async ()=>{
          const email = $("#email").value.trim();
          const pass  = $("#password").value;
          if(!email || pass.length<6){ toast("Email + password (6+ chars)"); return; }
          try{
            await createUserWithEmailAndPassword(auth, email, pass);
            toast("Registered!");
          }catch(e){
            toast(e.message);
          }
        });
        $("#btnLogin").addEventListener("click", async ()=>{
          const email = $("#email").value.trim();
          const pass  = $("#password").value;
          if(!email || !pass){ toast("Enter email + password"); return; }
          try{
            await signInWithEmailAndPassword(auth, email, pass);
            toast("Logged in!");
          }catch(e){
            toast(e.message);
          }
        });

        const navDashboard = $("#btnNavDashboard");
        const navAccount = $("#btnAccount");
        const accountCard = $("#accountCard");
        const dashboardView = $("#dashboardView");

        function showDashboard() {
            accountCard.style.display = "none";
            dashboardView.style.display = "block";
            navDashboard.classList.add("active");
            navAccount.classList.remove("active");
        }

        function showAccount() {
            accountCard.style.display = "block";
            dashboardView.style.display = "none";
            navDashboard.classList.remove("active");
            navAccount.classList.add("active");
        }

        navDashboard.addEventListener("click", showDashboard);
        navAccount.addEventListener("click", showAccount);

        $("#btnLogout").addEventListener("click", async ()=>{
          await signOut(auth);
        });
        
        onAuthStateChanged(auth, async (user)=>{
          if(!user){
            currentUid = null;
            currentProjectId = null;
            currentRole = null;
            $("#authCard").style.display = "block";
            $("#app").style.display = "none";
            return;
          }
          currentUid = user.uid;
          $("#userEmail").textContent = user.email || user.uid;
          $("#userUid").textContent = user.uid;
          $("#emailVerified").textContent = user.emailVerified ? "Verified" : "Unverified";
        
          try{
            const profSnap = await get(ref(db, `users/${user.uid}/profile`));
            const prof = profSnap.val() || {};
            $("#username").value = prof.username || "";
            if(!prof.createdAt){
              await update(ref(db, `users/${user.uid}/profile`), { createdAt: now() });
            }
          }catch(_){ }
        
          $("#authCard").style.display = "none";
          $("#app").style.display = "flex";
          showDashboard();

          await loadProjects();
        });
        
        /* ---------------- PROJECTS ---------------- */
        async function loadProjects() {
            // Get IDs the user has access to
            const snap = await get(ref(db, `userProjects/${currentUid}`));
            const map = snap.val() || {};
            const ids = Object.keys(map);

            if (ids.length === 0) {
                renderDropdown([]);
                currentProjectId = null;
                $('#projectSelectLabel').textContent = "No Projects";
                return;
            }

            // Fetch NAMEs for all IDs to display in dropdown
            // We use Promise.all to fetch them in parallel
            const promises = ids.map(async (id) => {
                const pSnap = await get(ref(db, `projects/${id}/name`));
                return { id, name: pSnap.val() || "Untitled Project" };
            });

            const projects = await Promise.all(promises);
            
            // Build Custom Dropdown
            renderDropdown(projects);

            // Auto-select first if none selected
            if (!currentProjectId || !ids.includes(currentProjectId)) {
                await selectProject(ids[0]);
            } else {
                // Refresh label
                const current = projects.find(p => p.id === currentProjectId);
                if(current) $('#projectSelectLabel').textContent = current.name;
            }
        }
        
        async function selectProject(projectId){
          currentProjectId = projectId;
          currentRole = await getRole(projectId, currentUid);
          
          if(!currentRole){
            toast("No access to this project.");
            return;
          }

          // Update Dropdown Label visually
          const nameSnap = await get(ref(db, `projects/${projectId}/name`));
          const name = nameSnap.val() || "Project";
          $('#projectSelectLabel').textContent = name;
          
          // Re-render dropdown options to update "selected" class
          // (Lazy reload - strictly we should keep the array in memory, but this works)
          // For now, we assume loadProjects handles the list, we just update the active state visually if needed
          document.querySelectorAll('.custom-option').forEach(el => {
              el.classList.remove('selected');
              if(el.textContent.includes(name)) el.classList.add('selected'); // loose match for visual
          });
        
          // Live project meta
          if(projectUnsub) projectUnsub();
          projectUnsub = onValue(ref(db, `projects/${projectId}`), snap=>{
            const p = snap.val() || {};
            $("#projectName").value = p.name || "";
            $("#projectSlug").value = p.slug || "";
            if($("#slugPreview")) $("#slugPreview").innerText = p.slug || "...";
            $("#projectPublic").checked = !!p.public;
          });
          // Live services list
          mountServicesListener();
          // Load announcement
          onValue(ref(db, `announcements/${projectId}`), snap=>{
            const v = snap.val() || {};
            $("#announcement").value = v.text || "";
          }, { onlyOnce: false });
          toast(`Project loaded`);
        }
        
        $("#btnCreateProject").addEventListener("click", async ()=>{
          const name = prompt("Project name?");
          if(!name) return;
        
          const slug = slugify(name);
          if(!/^[a-z0-9-]{3,40}$/.test(slug)){ toast("Slug invalid"); return; }
        
          try{
            // 1) create project
            const projectId = push(ref(db, "projects")).key;
            await set(ref(db, `projects/${projectId}`), {
              name,
              slug,
              ownerUid: currentUid,
              public: true,
              createdAt: now()
            });
            // 2) create membership (bootstrap)
            await set(ref(db, `projectMembers/${projectId}/${currentUid}`), { role: "owner" });
            // 3) add project to user's list
            await set(ref(db, `userProjects/${currentUid}/${projectId}`), true);
            // 4) slug index
            await set(ref(db, `projectSlugs/${slug}`), projectId);
        
            toast("Project created");
            await loadProjects();
            await selectProject(projectId);
          }catch(e){
            toast(e.message);
          }
        });
        
        $("#btnSaveProject").addEventListener("click", async ()=>{
          try{
            requireProject();
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
        
            const name = $("#projectName").value.trim();
            let slug = slugify($("#projectSlug").value);
            const isPublic = $("#projectPublic").checked;
        
            if(!name){ toast("Name required"); return; }
            if(!/^[a-z0-9-]{3,40}$/.test(slug)){ toast("Slug must be 3-40 chars a-z 0-9 -"); return; }
        
            // Enforce unique slug via projectSlugs index
            const idxSnap = await get(ref(db, `projectSlugs/${slug}`));
            const existing = idxSnap.val();
            if(existing && existing !== currentProjectId){
              toast("Slug already used");
              return;
            }
        
            // Also clean up old slug index if slug changed
            const oldSnap = await get(ref(db, `projects/${currentProjectId}/slug`));
            const oldSlug = oldSnap.val();
            const updates = {};
            updates[`projects/${currentProjectId}/name`] = name;
            updates[`projects/${currentProjectId}/slug`] = slug;
            updates[`projects/${currentProjectId}/public`] = isPublic;
        
            if(oldSlug && oldSlug !== slug){
              updates[`projectSlugs/${oldSlug}`] = null;
            }
            updates[`projectSlugs/${slug}`] = currentProjectId;
        
            await update(ref(db), updates);
            // Reload sidebar to reflect new name
            await loadProjects(); 
            toast("Saved");
          }catch(e){
            toast(e.message);
          }
        });

        // --- DELETE PROJECT LOGIC ---
        $("#btnDeleteProject").addEventListener("click", async () => {
            try {
                requireProject();
                if (currentRole !== "owner") { toast("Only Owner can delete project"); return; }

                const name = $("#projectName").value;
                const confirmName = prompt(`To DELETE this project, type its name: "${name}"`);
                
                if (confirmName !== name) { toast("Name mismatch, deletion cancelled"); return; }

                const pid = currentProjectId;
                
                // Get slug to clean up index
                const slugSnap = await get(ref(db, `projects/${pid}/slug`));
                const slug = slugSnap.val();

                // Multi-path update to delete everything
                const updates = {};
                updates[`projects/${pid}`] = null;
                updates[`projectMembers/${pid}`] = null;
                updates[`services/${pid}`] = null;
                updates[`announcements/${pid}`] = null;
                updates[`incidents/${pid}`] = null;
                if(slug) updates[`projectSlugs/${slug}`] = null;
                
                // Note: We cannot easily delete from ALL users' userProjects without a cloud function or iterating all users (bad).
                // We CAN delete from current user. Other users will see a "dead" project link until they click it and we handle error, or we accept the garbage data.
                updates[`userProjects/${currentUid}/${pid}`] = null;

                await update(ref(db), updates);
                
                toast("Project Deleted");
                currentProjectId = null;
                await loadProjects(); // Will select next available or show empty
            } catch (e) {
                toast(e.message);
            }
        });

        $("#btnOpenPublic").addEventListener("click", async ()=>{
          try{
            requireProject();
            const snap = await get(ref(db, `projects/${currentProjectId}/slug`));
            const slug = snap.val();
            if(!slug){ toast("Set a slug first"); return; }
            window.open(`status.html?project=${encodeURIComponent(slug)}`, "_blank");
          }catch(e){
            toast(e.message);
          }
        });
        
        /* ---------------- ANNOUNCEMENT ---------------- */
        $("#btnSaveAnnouncement").addEventListener("click", async ()=>{
          try{
            requireProject();
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
        
            const text = $("#announcement").value;
            await set(ref(db, `announcements/${currentProjectId}`), { text, updatedAt: now() });
            toast("Announcement saved");
          }catch(e){
            toast(e.message);
          }
        });
        
        /* ---------------- SERVICES ---------------- */
        function mountServicesListener(){
          const holder = $("#services");
          onValue(ref(db, `services/${currentProjectId}`), snap=>{
            const services = snap.val() || {};
            const entries = Object.entries(services)
              .map(([id,s])=>({id,...s}))
              .sort((a,b)=>(a.order??0)-(b.order??0));
        
            holder.innerHTML = "";
            if(entries.length===0){
              holder.innerHTML = `<div class="sub-text" style="text-align:center; padding:20px;">No monitors yet. Add one above.</div>`;
              return;
            }
        
            for(const s of entries){
              holder.appendChild(renderServiceCard(s));
            }
          });
        }
        
        function statusOptions(selected){
          const opts = [
            ["operational","Operational (Online)"],
            ["down","Down (Offline)"],
            ["degraded","Degraded Performance"],
            ["paused","Paused"],
            ["maintenance","Maintenance"],
            ["unknown","Unknown"],
            ["unlinked","Unlinked"]
          ];
          return opts.map(([v,l])=>`<option value="${v}" ${v===selected?'selected':''}>${l}</option>`).join("");
        }
        
        function renderServiceCard(s){
          const wrap = document.createElement("div");
          wrap.className = "service-item";
          wrap.innerHTML = `
            <div class="service-header">
              <div>
                <div style="font-weight:600; font-size:16px; color:white;">${escapeHtml(s.name||"Unnamed")}</div>
                <div class="sub-text" style="margin:0; font-size:11px;">ID: ${s.id}</div>
              </div>
              <button class="btn-danger" data-act="remove">Remove</button>
            </div>
        
            <div class="grid-3">
              <div>
                <label>Name</label>
                <input data-k="name" type="text" value="${escapeAttr(s.name||"")}">
              </div>
              <div>
                <label>Order</label>
                <input data-k="order" type="number" value="${Number(s.order||0)}">
              </div>
              <div>
                <label>Target Date</label>
                <input data-k="date" type="date" value="${new Date().toISOString().split("T")[0]}">
              </div>
            </div>
        
            <div class="grid-3">
              <div>
                <label>Status</label>
                <select data-k="status">${statusOptions("operational")}</select>
              </div>
              <div>
                <label>Version</label>
                <input data-k="version" type="text" placeholder="2.1.0">
              </div>
              <div>
                <label>Notes</label>
                <input data-k="notes" type="text" placeholder="Short notes">
              </div>
            </div>
        
            <div class="btn-row">
              <button class="btn-primary" data-act="setDate">Update Status (Single Day)</button>
              <button class="btn-ghost" data-act="bulk14">Bulk Set (14 Days)</button>
            </div>
          `;
        
          const actRemove = wrap.querySelector('[data-act="remove"]');
          const actSet    = wrap.querySelector('[data-act="setDate"]');
          const actBulk   = wrap.querySelector('[data-act="bulk14"]');
          const nameInput = wrap.querySelector('input[data-k="name"]');
          const orderInput= wrap.querySelector('input[data-k="order"]');
        
          actRemove.addEventListener("click", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            if(!confirm(`Remove "${s.name}"?`)) return;
            await remove(ref(db, `services/${currentProjectId}/${s.id}`));
            toast("Removed");
          });
          nameInput.addEventListener("change", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            await update(ref(db, `services/${currentProjectId}/${s.id}`), { name: nameInput.value.trim(), lastUpdated: now() });
            toast("Saved");
          });
          orderInput.addEventListener("change", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            await update(ref(db, `services/${currentProjectId}/${s.id}`), { order: Number(orderInput.value||0), lastUpdated: now() });
            toast("Saved");
          });
          actSet.addEventListener("click", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            const date = wrap.querySelector('input[data-k="date"]').value;
            const status = wrap.querySelector('select[data-k="status"]').value;
            const version = wrap.querySelector('input[data-k="version"]').value.trim();
            const notes = wrap.querySelector('input[data-k="notes"]').value.trim();
        
            const payload = { status, timestamp: now() };
            if(version) payload.version = version;
            if(notes) payload.notes = notes;
        
            const updates = {};
            updates[`services/${currentProjectId}/${s.id}/history/${date}`] = payload;
            updates[`services/${currentProjectId}/${s.id}/lastUpdated`] = now();
            await update(ref(db), updates);
            toast("Saved date");
          });
          actBulk.addEventListener("click", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            const status = wrap.querySelector('select[data-k="status"]').value;
            if(!confirm(`Set "${status}" for last 14 days?`)) return;
        
            const updates = {};
            for(let i=13;i>=0;i--){
              const d = new Date();
              d.setDate(d.getDate()-i);
              const ds = d.toISOString().split("T")[0];
              updates[`services/${currentProjectId}/${s.id}/history/${ds}`] = { status, timestamp: now() };
            }
            updates[`services/${currentProjectId}/${s.id}/lastUpdated`] = now();
            await update(ref(db), updates);
            toast("Bulk saved");
          });
          return wrap;
        }
        
        function escapeHtml(s){
          return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }
        function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
        
        $("#btnAddService").addEventListener("click", async ()=>{
          try{
            requireProject();
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            const name = $("#newServiceName").value.trim();
            const order = Number($("#newServiceOrder").value||0);
            if(!name){ toast("Service name required"); return; }
        
            const serviceId = push(ref(db, `services/${currentProjectId}`)).key;
            await set(ref(db, `services/${currentProjectId}/${serviceId}`), {
              name, order, lastUpdated: now(), history: {}
            });
            $("#newServiceName").value = "";
            toast("Service added");
          }catch(e){ toast(e.message); }
        });
        
        /* ---------------- LEGACY IMPORT ---------------- */
        $("#btnImportLegacy").addEventListener("click", async ()=>{
          try{
            requireProject();
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            if(!confirm("Import legacy statusApps from DB root into this project?")) return;
            const legacySnap = await get(ref(db, "statusApps"));
            const legacy = legacySnap.val() || [];
            if(!Array.isArray(legacy) || legacy.length===0){ toast("No legacy array found"); return; }
        
            const updates = {};
            legacy.forEach((app)=>{
              const id = push(ref(db, `services/${currentProjectId}`)).key;
              updates[`services/${currentProjectId}/${id}`] = {
                name: app.name || "Imported",
                order: 0,
                lastUpdated: app.lastUpdated || now(),
                history: app.history || {}
              };
            });
            await update(ref(db), updates);
            toast("Imported");
          }catch(e){ toast(e.message); }
        });

        // Account actions placeholders
        $("#btnRefreshUser").addEventListener("click", async ()=>{
            const user = auth.currentUser;
            if(!user) return;
            await user.reload();
            toast("Refreshed");
        });
        $("#btnSendVerify").addEventListener("click", async ()=>{
            const user = auth.currentUser;
            if(!user) return;
            await sendEmailVerification(user);
            toast("Sent");
        });
        $("#btnRequestDeletion").addEventListener("click", async ()=>{
            toast("Request Sent");
        });
        $("#btnSaveUsername").addEventListener("click", async ()=>{
             toast("Saved");
        });
        $("#btnChangeEmail").addEventListener("click", async ()=>{
             toast("Check Email");
        });
        $("#btnChangePassword").addEventListener("click", async ()=>{
             toast("Password Updated");
        });
        $("#btnExportData").addEventListener("click", async ()=>{
             toast("Exporting...");
        });
        $("#btnDeleteAccount").addEventListener("click", async ()=>{
             if(confirm("Delete Account?")) toast("Deleted");
        });
        </script>
</body>
</html>
