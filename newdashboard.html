<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UpTrace - Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Kode+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121010;
            --card-bg: #141212;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --accent-red: #e66e6e;
            --accent-blue: #0099ff;
            --input-bg: rgba(187, 187, 187, 0.15);
            --input-border: rgba(136, 136, 136, 0.1);
            --border-radius: 13px;
            --font-head: "Kode Mono", monospace;
            --font-body: "Inter", sans-serif;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 14px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Ambient Background Effects (From Framer) --- */
        .ambient-glow {
            position: fixed;
            width: 500px;
            height: 500px;
            background: radial-gradient(50% 50%, rgba(255, 51, 51, 0.15) 0%, rgba(138, 0, 0, 0) 100%);
            filter: blur(80px);
            z-index: -1;
            pointer-events: none;
        }
        .glow-1 { top: -150px; left: -150px; }
        .glow-2 { bottom: -150px; right: -150px; }
        .glow-3 { top: 40%; left: 30%; width: 300px; height: 300px; opacity: 0.5; }

        /* --- Typography --- */
        h1, h2, h3 { font-family: var(--font-head); font-weight: 400; margin: 0; }
        h1 { font-size: 24px; color: var(--accent-red); margin-bottom: 5px; }
        h2 { font-size: 18px; margin-bottom: 15px; color: white; }
        .sub-text { color: var(--text-secondary); font-weight: 300; font-size: 13px; margin-bottom: 20px; }
        code { font-family: var(--font-head); background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 4px; color: var(--accent-blue); }

        /* --- Layout --- */
        .layout-container {
            display: flex;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        .sidebar {
            width: 260px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .layout-container { flex-direction: column; }
            .sidebar { width: 100%; }
        }

        /* --- Components --- */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }

        .menu-btn {
            background-color: transparent;
            color: var(--text-secondary);
            border: 1px solid transparent;
            padding: 12px 15px;
            border-radius: 8px;
            text-align: left;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            font-size: 13px;
        }
        .menu-btn:hover { background: rgba(255,255,255,0.03); color: white; }
        .menu-btn.active { background: rgba(230, 110, 110, 0.1); color: var(--accent-red); border: 1px solid rgba(230, 110, 110, 0.2); }
        .menu-btn img { width: 20px; height: 20px; border-radius: 50%; opacity: 0.7; }

        /* --- Form Elements (Framer Style) --- */
        label {
            display: block;
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 8px;
            margin-top: 15px;
            font-weight: 300;
        }

        input, select, textarea {
            width: 100%;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 10px;
            font-family: var(--font-body);
            font-size: 14px;
            transition: 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-blue);
            background: rgba(0, 153, 255, 0.05);
        }
        
        input::placeholder, textarea::placeholder { color: #555; }
        select { -webkit-appearance: none; cursor: pointer; }

        /* --- Buttons --- */
        .btn-primary, .btn-danger, .btn-ghost {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid rgba(230, 110, 110, 0.1);
            background: rgba(230, 110, 110, 0.05);
            color: white;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: rgba(230, 110, 110, 0.15);
            border-color: rgba(230, 110, 110, 0.3);
            transform: translateY(-1px);
        }

        .btn-danger {
            border-color: rgba(255, 50, 50, 0.2);
            background: rgba(255, 50, 50, 0.05);
            color: #ffaaaa;
        }
        .btn-danger:hover { background: rgba(255, 50, 50, 0.15); }

        .btn-ghost {
            background: transparent;
            border-color: transparent;
            color: var(--text-secondary);
        }
        .btn-ghost:hover { color: white; }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* --- Auth Screen Centering --- */
        #authCard {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }

        /* --- Service Items --- */
        .service-item {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        @media(max-width: 768px) { .grid-3 { grid-template-columns: 1fr; } }

        /* --- Toast --- */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1a1a1a;
            border: 1px solid var(--accent-blue);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            opacity: 0;
            transform: translateY(20px);
            transition: 0.3s;
            z-index: 1000;
            font-family: var(--font-head);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .separator {
            height: 1px;
            background: rgba(255,255,255,0.05);
            width: 100%;
            margin: 25px 0;
        }

        .badge {
            background: rgba(0, 153, 255, 0.1);
            color: var(--accent-blue);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: var(--font-head);
        }
    
/* ==== CUSTOM PROJECT DROPDOWN + IMPROVEMENTS ==== */
.project-dropdown{position:relative}
.project-selected{background:var(--input-bg);border:1px solid var(--input-border);padding:12px;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.project-selected:hover{border-color:var(--accent-blue)}
.project-options{display:none;position:absolute;top:calc(100% + 6px);left:0;right:0;background:#161414;border:1px solid rgba(255,255,255,.08);border-radius:10px;z-index:100;max-height:260px;overflow-y:auto}
.project-options.open{display:block}
.project-option{padding:12px;cursor:pointer;display:flex;gap:10px;align-items:center}
.project-option:hover{background:rgba(255,255,255,.05)}
.project-dot{width:10px;height:10px;border-radius:50%}
.project-icon{width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:12px;border-radius:4px;background:rgba(255,255,255,.08)}

</style>
</head>
<body>

    <div class="ambient-glow glow-1"></div>
    <div class="ambient-glow glow-2"></div>
    <div class="ambient-glow glow-3"></div>
    <div id="toast" class="toast">Action Successful</div>

    <div id="authCard" class="card" style="display:none;">
        <h1>UpTrace</h1>
        <p class="sub-text">Trace your status for free. Login to continue.</p>
        
        <div style="text-align: left;">
            <label>Email</label>
            <input id="email" type="email" placeholder="you@example.com" autocomplete="email">
            
            <label>Password</label>
            <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>

        <div class="btn-row" style="justify-content: center;">
            <button class="btn-primary" id="btnLogin">Login</button>
            <button class="btn-ghost" id="btnRegister">Register</button>
        </div>
    </div>

    <div id="app" class="layout-container" style="display:none;">
        
        <div class="sidebar">
            <div class="card" style="padding: 20px;">
                <h1 style="font-size: 20px;">UpTrace</h1>
                <div class="badge" id="userEmail">Loading...</div>
                
                <div class="separator" style="margin: 15px 0;"></div>

                <label style="margin-top:0;">Current Project</label>
                <div class="project-dropdown">
                  <div id="projectSelected" class="project-selected">Select project <span>â–¾</span></div>
                  <div id="projectOptions" class="project-options"></div>
                </div>
                <select id="projectSelect" style="display:none;"></select>
                <button id="btnCreateProject" class="btn-ghost" style="width:100%; justify-content: flex-start; padding-left:0;">+ New Project</button>
                <button id="btnDeleteProject" class="btn-danger" style="width:100%; margin-top:8px;">Delete Project</button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 5px;">
                <button class="menu-btn active" id="btnNavDashboard">
                    <span style="width:10px; height:10px; background:var(--accent-red); border-radius:50%; display:inline-block; margin-right:5px;"></span>
                    Dashboard
                </button>
                <button class="menu-btn" id="btnAccount">
                    Manage Account
                </button>
                <a href="https://discord.gg/r5SyNyCYjb" target="_blank" class="menu-btn">Discord Community</a>
                <button class="menu-btn" id="btnLogout" style="margin-top: 10px; color: #e66e6e;">Logout</button>
            </div>
        </div>

        <div class="main-content">
            
            <div id="accountCard" class="card" style="display:none;">
                <h2>Account Settings</h2>
                <div class="grid-3">
                    <div>
                        <label>UID</label>
                        <code id="userUid" style="display:block; margin-top:5px; word-break: break-all;">...</code>
                    </div>
                    <div>
                        <label>Verified</label>
                        <code id="emailVerified">...</code>
                    </div>
                </div>

                <div class="separator"></div>

                <div class="grid-3">
                    <div>
                        <label>Username</label>
                        <input id="username" type="text" placeholder="username">
                        <button class="btn-primary" id="btnSaveUsername" style="margin-top:10px; width:100%">Save</button>
                    </div>
                    <div>
                        <label>Change Email</label>
                        <input id="newEmail" type="email" placeholder="new@email.com">
                        <button id="btnChangeEmail" class="btn-primary" style="margin-top:10px; width:100%">Update</button>
                    </div>
                    <div>
                        <label>Change Password</label>
                        <input id="newPassword" type="password" placeholder="New Password">
                        <button id="btnChangePassword" class="btn-primary" style="margin-top:10px; width:100%">Update</button>
                    </div>
                </div>

                <div class="separator"></div>
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="color:white; font-weight:500">Data & Privacy</div>
                        <div class="sub-text" style="margin:0">Manage your data export or deletion.</div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button id="btnExportData" class="btn-ghost">Export JSON</button>
                        <button id="btnDeleteAccount" class="btn-danger">Delete Account</button>
                        <button id="btnRequestDeletion" style="display:none"></button> <button id="btnSendVerify" style="display:none"></button> <button id="btnRefreshUser" style="display:none"></button> </div>
                </div>
            </div>

            <div id="dashboardView">
                
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <h2>Project Settings</h2>
                        <button id="btnOpenPublic" class="btn-primary">View Public Page â†—</button>
                    </div>

                    <div class="grid-3">
                        <div>
                            <label>Project Name</label>
                            <input id="projectName" type="text" placeholder="My App Status">
                        </div>
                        <div>
                            <label>Slug (URL)</label>
                            <input id="projectSlug" type="text" placeholder="my-app">
                        </div>
                        <div>
                            <label>Visibility</label>
                            <div style="margin-top:12px; display:flex; align-items:center; gap:10px; color:var(--text-secondary);">
                                <input id="projectPublic" type="checkbox" style="width:auto; margin:0;">
                                <span>Publicly Visible</span>
                            </div>
                        </div>
                    </div>

                    <div class="btn-row">
                        <button id="btnSaveProject" class="btn-primary">Save Settings</button>
                    </div>
                    <p class="sub-text" style="margin-top:15px;">Public URL: https://uptrace.lol/status.html?project=<span id="slugPreview">...</span></p>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>Announcement</h2>
                    <p class="sub-text">This message appears at the top of your public status page.</p>
                    <textarea id="announcement" placeholder="e.g. Scheduled maintenance this Sunday..." rows="3"></textarea>
                    <div class="btn-row">
                        <button id="btnSaveAnnouncement" class="btn-primary">Update Announcement</button>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>Services & Monitors</h2>
                    
                    <div style="background: rgba(255,255,255,0.03); padding:15px; border-radius:10px; margin-bottom:20px;">
                        <div class="grid-3" style="align-items: end;">
                            <div style="grid-column: span 2;">
                                <label>New Service Name</label>
                                <input id="newServiceName" type="text" placeholder="e.g. API Server, Database, Website">
                            </div>
                            <div style="display:none"><input id="newServiceOrder" value="0"></div> <button id="btnAddService" class="btn-primary" style="height: 42px;">+ Add Service</button>
                        </div>
                    </div>

                    <div id="services">
                        </div>
                </div>

                <div class="card" style="margin-top:20px; border-color: rgba(255,255,255,0.02);">
                    <h3 style="font-size:16px; color:#666;">Legacy Data</h3>
                    <p class="sub-text">Import statusApps from root DB (One-time action)</p>
                    <button id="btnImportLegacy" class="btn-ghost" style="border:1px solid #333;">Run Import</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./firebase.js";
        import {
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          onAuthStateChanged,
          signOut,
          sendEmailVerification,
          updateEmail,
          updatePassword,
          deleteUser,
          EmailAuthProvider,
          reauthenticateWithCredential,
          verifyBeforeUpdateEmail
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import {
          ref, get, set, update, push, remove, onValue, child
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        
        const $ = (q)=>document.querySelector(q);
        function toast(msg){
          const el = $("#toast");
          el.textContent = msg;
          el.classList.add("show");
          setTimeout(()=>el.classList.remove("show"), 2400);
        }
        
        function slugify(s){
          return String(s||"")
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g,'-')
            .replace(/^-+|-+$/g,'')
            .slice(0,40);
        }
        
        function now(){ return Date.now(); }
        
        let currentUid = null;
        let currentProjectId = null;
        let currentRole = null;
        let servicesUnsub = null;
        let projectUnsub = null;
        
        async function getRole(projectId, uid){
          const snap = await get(ref(db, `projectMembers/${projectId}/${uid}/role`));
          return snap.val() || null;
        }
        
        function requireProject(){
          if(!currentProjectId) throw new Error("Pick a project first.");
        }
        
        /* ---------------- ACCOUNT HELPERS ---------------- */
        async function promptReauth(user){
          if(!user?.email) throw new Error("Re-auth requires an email/password account.");
          const pass = prompt("For security, re-enter your current password:");
          if(!pass) throw new Error("Re-auth cancelled");
          const cred = EmailAuthProvider.credential(user.email, pass);
          await reauthenticateWithCredential(user, cred);
        }
        
        function downloadJson(filename, obj){
          const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }
        
        /* ---------------- AUTH UI ---------------- */
        $("#btnRegister").addEventListener("click", async ()=>{
          const email = $("#email").value.trim();
          const pass  = $("#password").value;
          if(!email || pass.length<6){ toast("Email + password (6+ chars)"); return; }
          try{
            await createUserWithEmailAndPassword(auth, email, pass);
            toast("Registered!");
          }catch(e){
            toast(e.message);
          }
        });
        $("#btnLogin").addEventListener("click", async ()=>{
          const email = $("#email").value.trim();
          const pass  = $("#password").value;
          if(!email || !pass){ toast("Enter email + password"); return; }
          try{
            await signInWithEmailAndPassword(auth, email, pass);
            toast("Logged in!");
          }catch(e){
            toast(e.message);
          }
        });

        // Simple Tab Switching Logic for new UI
        const navDashboard = $("#btnNavDashboard");
        const navAccount = $("#btnAccount"); // Sidebar button
        const accountCard = $("#accountCard");
        const dashboardView = $("#dashboardView"); // New wrapper for dashboard elements

        function showDashboard() {
            accountCard.style.display = "none";
            dashboardView.style.display = "block";
            navDashboard.classList.add("active");
            navAccount.classList.remove("active");
        }

        function showAccount() {
            accountCard.style.display = "block";
            dashboardView.style.display = "none";
            navDashboard.classList.remove("active");
            navAccount.classList.add("active");
        }

        navDashboard.addEventListener("click", showDashboard);
        navAccount.addEventListener("click", showAccount);

        $("#btnLogout").addEventListener("click", async ()=>{
          await signOut(auth);
        });
        
        onAuthStateChanged(auth, async (user)=>{
          if(!user){
            currentUid = null;
            currentProjectId = null;
            currentRole = null;
            $("#authCard").style.display = "block";
            $("#app").style.display = "none";
            return;
          }
          currentUid = user.uid;
          $("#userEmail").textContent = user.email || user.uid;
        
          // Account header fields
          $("#userUid").textContent = user.uid;
          $("#emailVerified").textContent = user.emailVerified ? "Verified" : "Unverified";
        
          // Ensure user profile exists (best-effort; requires rules for users/$uid)
          try{
            const profSnap = await get(ref(db, `users/${user.uid}/profile`));
            const prof = profSnap.val() || {};
            $("#username").value = prof.username || "";
            if(!prof.createdAt){
              await update(ref(db, `users/${user.uid}/profile`), { createdAt: now() });
            }
          }catch(_){
            // If you didn't add rules for users/$uid yet, dashboard still works.
          }
        
          $("#authCard").style.display = "none";
          $("#app").style.display = "flex"; // Changed to Flex for layout
          showDashboard(); // Default to dashboard view

          await loadProjects();
        });
        
        /* ---------------- ACCOUNT ACTIONS ---------------- */
        $("#btnRefreshUser").addEventListener("click", async ()=>{
          const user = auth.currentUser;
          if(!user) return;
          try{
            await user.reload();
            $("#userEmail").textContent = user.email || user.uid;
            $("#userUid").textContent = user.uid;
            $("#emailVerified").textContent = user.emailVerified ? "Verified" : "Unverified";
            toast("Refreshed");
          }catch(e){
            toast(e.message);
          }
        });
        $("#btnSendVerify").addEventListener("click", async ()=>{
          const user = auth.currentUser;
          if(!user) return;
          try{
            await sendEmailVerification(user);
            toast("Verification email sent");
          }catch(e){
            toast(e.message);
          }
        });
        $("#btnSaveUsername").addEventListener("click", async ()=>{
          const user = auth.currentUser;
          if(!user) return;
          const username = ($("#username").value || "").trim();
        
          if(username.length > 24){ toast("Username max 24 chars"); return; }
          if(username && !/^[a-zA-Z0-9_.-]{3,24}$/.test(username)){
            toast("Use 3-24 chars: letters, numbers, _ . -");
            return;
          }
        
          try{
            await update(ref(db, `users/${user.uid}/profile`), { username });
            toast("Username saved");
          }catch(e){
            toast(e.message);
          }
        });
        $("#btnChangeEmail").addEventListener("click", async ()=>{
          const user = auth.currentUser;
          if(!user) return;
          const newEmail = ($("#newEmail").value || "").trim();
          if(!newEmail){ toast("Enter new email"); return; }
        
          try{
            await verifyBeforeUpdateEmail(user, newEmail);
            toast("Check your NEW email to confirm the change");
            $("#newEmail").value = "";
          }catch(e){
            if(String(e.code||"").includes("requires-recent-login")){
              try{
                await promptReauth(user);
                await verifyBeforeUpdateEmail(user, newEmail);
                toast("Check your NEW email to confirm the change");
                $("#newEmail").value = "";
              }catch(e2){
                toast(e2.message || String(e2));
              }
            }else{
              toast(e.message);
            }
          }
        });
        $("#btnChangePassword").addEventListener("click", async ()=>{
          const user = auth.currentUser;
          if(!user) return;
          const newPass = ($("#newPassword").value || "");
          if(!newPass || newPass.length < 6){ toast("Password must be 6+ chars"); return; }
        
          try{
            await updatePassword(user, newPass);
            toast("Password updated");
            $("#newPassword").value = "";
          }catch(e){
            if(String(e.code||"").includes("requires-recent-login")){
              try{
                await promptReauth(user);
                await updatePassword(user, newPass);
                toast("Password updated");
                $("#newPassword").value = "";
              }catch(e2){
                toast(e2.message || String(e2));
              }
            }else{
              toast(e.message);
            }
          }
        });
        $("#btnRequestDeletion").addEventListener("click", async ()=>{
          const user = auth.currentUser;
          if(!user) return;
          try{
            await update(ref(db, `users/${user.uid}/profile`), { deletionRequestedAt: now() });
            toast("Deletion request stored");
          }catch(e){
            toast(e.message);
          }
        });
        $("#btnDeleteAccount").addEventListener("click", async ()=>{
          const user = auth.currentUser;
          if(!user) return;
        
          const ok = confirm("This will DELETE your Firebase Auth account instantly. Continue?");
          if(!ok) return;
        
          try{
            try{ await update(ref(db, `users/${user.uid}/profile`), { deletionRequestedAt: now() }); }catch(_){}
        
            await deleteUser(user);
            toast("Account deleted");
          }catch(e){
            if(String(e.code||"").includes("requires-recent-login")){
              try{
                await promptReauth(user);
                await deleteUser(user);
                toast("Account deleted");
              }catch(e2){
                toast(e2.message || String(e2));
              }
            }else{
              toast(e.message);
            }
          }
        });
        $("#btnExportData").addEventListener("click", async ()=>{
          const user = auth.currentUser;
          if(!user) return;
        
          try{
            const up = await get(ref(db, `userProjects/${user.uid}`));
            const map = up.val() || {};
            const projectIds = Object.keys(map);
        
            const out = {
              exportedAt: new Date().toISOString(),
              uid: user.uid,
              email: user.email,
              emailVerified: !!user.emailVerified,
              profile: {},
              projects: {}
            };
        
            try{
              out.profile = (await get(ref(db, `users/${user.uid}/profile`))).val() || {};
            }catch(_){}
        
            for(const pid of projectIds){
              const p = (await get(ref(db, `projects/${pid}`))).val();
              if(!p) continue;
        
              const role = (await get(ref(db, `projectMembers/${pid}/${user.uid}/role`))).val();
              const data = { meta: p, yourRole: role || null };
        
              data.services = (await get(ref(db, `services/${pid}`))).val() || {};
              data.announcements = (await get(ref(db, `announcements/${pid}`))).val() || {};
              data.incidents = (await get(ref(db, `incidents/${pid}`))).val() || {};
              data.members = (await get(ref(db, `projectMembers/${pid}`))).val() || {};
        
              out.projects[pid] = data;
            }
        
            downloadJson(`ezstatus-export-${user.uid}.json`, out);
            toast("Exported");
          }catch(e){
            toast(e.message);
          }
        });
        
        /* ---------------- PROJECTS ---------------- */
        loadProjects = async function(){
          const snap = await get(ref(db, `userProjects/${currentUid}`));
          const map = snap.val() || {};
          const ids = Object.keys(map);
        
          const sel = $("#projectSelect");
          sel.innerHTML = "";
          if(ids.length===0){
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "No projects (create one)";
            sel.appendChild(opt);
            currentProjectId = null;
            return;
          }
        
          for(const id of ids){
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = id;
            sel.appendChild(opt);
          }
        
          sel.value = ids[0];
          await selectProject(ids[0]);
        }
        
        $("#projectSelect").addEventListener("change", async ()=>{
          const id = $("#projectSelect").value;
          if(id) await selectProject(id);
        });
        
        async function selectProject(projectId){
          currentProjectId = projectId;
          currentRole = await getRole(projectId, currentUid);
          if(!currentRole){
            toast("No access to this project.");
            return;
          }
        
          // Live project meta
          if(projectUnsub) projectUnsub();
          projectUnsub = onValue(ref(db, `projects/${projectId}`), snap=>{
            const p = snap.val() || {};
            $("#projectName").value = p.name || "";
            $("#projectSlug").value = p.slug || "";
            if($("#slugPreview")) $("#slugPreview").innerText = p.slug || "...";
            $("#projectPublic").checked = !!p.public;
          });
          // Live services list
          mountServicesListener();
          // Load announcement
          onValue(ref(db, `announcements/${projectId}`), snap=>{
            const v = snap.val() || {};
            $("#announcement").value = v.text || "";
          }, { onlyOnce: false });
          toast(`Project selected`);
        }
        
        $("#btnCreateProject").addEventListener("click", async ()=>{
          const name = prompt("Project name?");
          if(!name) return;
        
          const slug = slugify(name);
          if(!/^[a-z0-9-]{3,40}$/.test(slug)){ toast("Slug invalid"); return; }
        
          try{
            // 1) create project
            const projectId = push(ref(db, "projects")).key;
            await set(ref(db, `projects/${projectId}`), {
              name,
              slug,
              ownerUid: currentUid,
              public: true,
              createdAt: now()
            });
            // 2) create membership (bootstrap)
            await set(ref(db, `projectMembers/${projectId}/${currentUid}`), { role: "owner" });
            // 3) add project to user's list
            await set(ref(db, `userProjects/${currentUid}/${projectId}`), true);
            // 4) slug index
            await set(ref(db, `projectSlugs/${slug}`), projectId);
        
            toast("Project created");
            await loadProjects();
            $("#projectSelect").value = projectId;
            await selectProject(projectId);
          }catch(e){
            toast(e.message);
          }
        });
        
        
        $("#btnSaveProject").addEventListener("click", async ()=>{
          try{
            requireProject();
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
        
            const name = $("#projectName").value.trim();
            let slug = slugify($("#projectSlug").value);
            const isPublic = $("#projectPublic").checked;
        
            if(!name){ toast("Name required"); return; }
            if(!/^[a-z0-9-]{3,40}$/.test(slug)){ toast("Slug must be 3-40 chars a-z 0-9 -"); return; }
        
            // Enforce unique slug via projectSlugs index
            const idxSnap = await get(ref(db, `projectSlugs/${slug}`));
            const existing = idxSnap.val();
            if(existing && existing !== currentProjectId){
              toast("Slug already used");
              return;
            }
        
            // Also clean up old slug index if slug changed
            const oldSnap = await get(ref(db, `projects/${currentProjectId}/slug`));
            const oldSlug = oldSnap.val();
            const updates = {};
            updates[`projects/${currentProjectId}/name`] = name;
            updates[`projects/${currentProjectId}/slug`] = slug;
            updates[`projects/${currentProjectId}/public`] = isPublic;
        
            if(oldSlug && oldSlug !== slug){
              updates[`projectSlugs/${oldSlug}`] = null;
            }
            updates[`projectSlugs/${slug}`] = currentProjectId;
        
            await update(ref(db), updates);
            toast("Saved");
          }catch(e){
            toast(e.message);
          }
        });
        $("#btnOpenPublic").addEventListener("click", async ()=>{
          try{
            requireProject();
            const snap = await get(ref(db, `projects/${currentProjectId}/slug`));
            const slug = snap.val();
            if(!slug){ toast("Set a slug first"); return; }
            window.open(`status.html?project=${encodeURIComponent(slug)}`, "_blank");
          }catch(e){
            toast(e.message);
          }
        });
        
        /* ---------------- ANNOUNCEMENT ---------------- */
        $("#btnSaveAnnouncement").addEventListener("click", async ()=>{
          try{
            requireProject();
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
        
            const text = $("#announcement").value;
            await set(ref(db, `announcements/${currentProjectId}`), { text, updatedAt: now() });
            toast("Announcement saved");
          }catch(e){
            toast(e.message);
          }
        });
        
        /* ---------------- SERVICES ---------------- */
        function mountServicesListener(){
          const holder = $("#services");
          onValue(ref(db, `services/${currentProjectId}`), snap=>{
            const services = snap.val() || {};
            const entries = Object.entries(services)
              .map(([id,s])=>({id,...s}))
              .sort((a,b)=>(a.order??0)-(b.order??0));
        
            holder.innerHTML = "";
            if(entries.length===0){
              holder.innerHTML = `<div class="sub-text" style="text-align:center; padding:20px;">No monitors yet. Add one above.</div>`;
              return;
            }
        
            for(const s of entries){
              holder.appendChild(renderServiceCard(s));
            }
          });
        }
        
        function statusOptions(selected){
          const opts = [
            ["operational","Operational (Online)"],
            ["down","Down (Offline)"],
            ["degraded","Degraded Performance"],
            ["paused","Paused"],
            ["maintenance","Maintenance"],
            ["unknown","Unknown"],
            ["unlinked","Unlinked"]
          ];
          return opts.map(([v,l])=>`<option value="${v}" ${v===selected?'selected':''}>${l}</option>`).join("");
        }
        
        function renderServiceCard(s){
          const wrap = document.createElement("div");
          wrap.className = "service-item";
          wrap.innerHTML = `
            <div class="service-header">
              <div>
                <div style="font-weight:600; font-size:16px; color:white;">${escapeHtml(s.name||"Unnamed")}</div>
                <div class="sub-text" style="margin:0; font-size:11px;">ID: ${s.id}</div>
              </div>
              <button class="btn-danger" data-act="remove">Remove</button>
            </div>
        
            <div class="grid-3">
              <div>
                <label>Name</label>
                <input data-k="name" type="text" value="${escapeAttr(s.name||"")}">
              </div>
              <div>
                <label>Order</label>
                <input data-k="order" type="number" value="${Number(s.order||0)}">
              </div>
              <div>
                <label>Target Date</label>
                <input data-k="date" type="date" value="${new Date().toISOString().split("T")[0]}">
              </div>
            </div>
        
            <div class="grid-3">
              <div>
                <label>Status</label>
                <select data-k="status">${statusOptions("operational")}</select>
              </div>
              <div>
                <label>Version</label>
                <input data-k="version" type="text" placeholder="2.1.0">
              </div>
              <div>
                <label>Notes</label>
                <input data-k="notes" type="text" placeholder="Short notes">
              </div>
            </div>
        
            <div class="btn-row">
              <button class="btn-primary" data-act="setDate">Update Status (Single Day)</button>
              <button class="btn-ghost" data-act="bulk14">Bulk Set (14 Days)</button>
            </div>
          `;
        
          const actRemove = wrap.querySelector('[data-act="remove"]');
          const actSet    = wrap.querySelector('[data-act="setDate"]');
          const actBulk   = wrap.querySelector('[data-act="bulk14"]');
          const nameInput = wrap.querySelector('input[data-k="name"]');
          const orderInput= wrap.querySelector('input[data-k="order"]');
        
          actRemove.addEventListener("click", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            if(!confirm(`Remove "${s.name}"?`)) return;
            await remove(ref(db, `services/${currentProjectId}/${s.id}`));
            toast("Removed");
          });
          nameInput.addEventListener("change", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            await update(ref(db, `services/${currentProjectId}/${s.id}`), { name: nameInput.value.trim(), lastUpdated: now() });
            toast("Saved");
          });
          orderInput.addEventListener("change", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            await update(ref(db, `services/${currentProjectId}/${s.id}`), { order: Number(orderInput.value||0), lastUpdated: now() });
            toast("Saved");
          });
          actSet.addEventListener("click", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            const date = wrap.querySelector('input[data-k="date"]').value;
            const status = wrap.querySelector('select[data-k="status"]').value;
            const version = wrap.querySelector('input[data-k="version"]').value.trim();
            const notes = wrap.querySelector('input[data-k="notes"]').value.trim();
        
            const payload = { status, timestamp: now() };
            if(version) payload.version = version;
            if(notes) payload.notes = notes;
        
            const updates = {};
            updates[`services/${currentProjectId}/${s.id}/history/${date}`] = payload;
            updates[`services/${currentProjectId}/${s.id}/lastUpdated`] = now();
            await update(ref(db), updates);
            toast("Saved date");
          });
          actBulk.addEventListener("click", async ()=>{
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            const status = wrap.querySelector('select[data-k="status"]').value;
            if(!confirm(`Set "${status}" for last 14 days?`)) return;
        
            const updates = {};
            for(let i=13;i>=0;i--){
              const d = new Date();
              d.setDate(d.getDate()-i);
              const ds = d.toISOString().split("T")[0];
              updates[`services/${currentProjectId}/${s.id}/history/${ds}`] = { status, timestamp: now() };
            }
            updates[`services/${currentProjectId}/${s.id}/lastUpdated`] = now();
            await update(ref(db), updates);
            toast("Bulk saved");
          });
          return wrap;
        }
        
        function escapeHtml(s){
          return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }
        function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
        
        $("#btnAddService").addEventListener("click", async ()=>{
          try{
            requireProject();
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            const name = $("#newServiceName").value.trim();
            const order = Number($("#newServiceOrder").value||0);
            if(!name){ toast("Service name required"); return; }
        
            const serviceId = push(ref(db, `services/${currentProjectId}`)).key;
            await set(ref(db, `services/${currentProjectId}/${serviceId}`), {
              name, order, lastUpdated: now(), history: {}
            });
            $("#newServiceName").value = "";
            toast("Service added");
          }catch(e){ toast(e.message); }
        });
        
        /* ---------------- LEGACY IMPORT ---------------- */
        $("#btnImportLegacy").addEventListener("click", async ()=>{
          try{
            requireProject();
            if(!["owner","admin"].includes(currentRole)){ toast("Need admin/owner"); return; }
            if(!confirm("Import legacy statusApps from DB root into this project?")) return;
            const legacySnap = await get(ref(db, "statusApps"));
            const legacy = legacySnap.val() || [];
            if(!Array.isArray(legacy) || legacy.length===0){ toast("No legacy array found"); return; }
        
            const updates = {};
            legacy.forEach((app)=>{
              const id = push(ref(db, `services/${currentProjectId}`)).key;
              updates[`services/${currentProjectId}/${id}`] = {
                name: app.name || "Imported",
                order: 0,
                lastUpdated: app.lastUpdated || now(),
                history: app.history || {}
              };
            });
            await update(ref(db), updates);
            toast("Imported");
          }catch(e){ toast(e.message); }
        });
        
/* ==== PROJECT DROPDOWN LOGIC + IMPROVEMENTS ==== */
const projectSelected = document.getElementById("projectSelected");
const projectOptions = document.getElementById("projectOptions");

projectSelected?.addEventListener("click", ()=>{
  projectOptions.classList.toggle("open");
});

document.addEventListener("click", e=>{
  if(!e.target.closest(".project-dropdown")){
    projectOptions.classList.remove("open");
  }
});

loadProjects = async function(){
  const snap = await get(ref(db, `userProjects/${currentUid}`));
  const map = snap.val() || {};
  const ids = Object.keys(map);

  projectOptions.innerHTML = "";

  if(ids.length===0){
    projectSelected.textContent = "No projects";
    currentProjectId = null;
    return;
  }

  for(const id of ids){
    const pSnap = await get(ref(db, `projects/${id}`));
    const p = pSnap.val();
    if(!p) continue;

    const color = p.color || "#e66e6e";
    const icon = p.icon || "ðŸ“¦";

    const opt = document.createElement("div");
    opt.className = "project-option";
    opt.innerHTML = `
      <div class="project-dot" style="background:${color}"></div>
      <div class="project-icon">${icon}</div>
      <div>${escapeHtml(p.name)}<br><small>${id}</small></div>
    `;

    opt.onclick = async ()=>{
      projectSelected.innerHTML = `${escapeHtml(p.name)} <span>â–¾</span>`;
      projectOptions.classList.remove("open");
      localStorage.setItem("recentProject", id);
      await selectProject(id);
    };

    projectOptions.appendChild(opt);
  }

  const last = localStorage.getItem("recentProject");
  const first = ids.includes(last) ? last : ids[0];
  const fp = await get(ref(db, `projects/${first}`));
  projectSelected.innerHTML = `${escapeHtml(fp.val().name)} <span>â–¾</span>`;
  await selectProject(first);
}

/* DELETE PROJECT */
document.getElementById("btnDeleteProject")?.addEventListener("click", async ()=>{
  try{
    requireProject();
    if(currentRole !== "owner"){
      toast("Only owner can delete project");
      return;
    }
    if(prompt("Type DELETE to confirm")!=="DELETE") return;

    const pid = currentProjectId;
    await remove(ref(db, `projects/${pid}`));
    await remove(ref(db, `services/${pid}`));
    await remove(ref(db, `announcements/${pid}`));
    await remove(ref(db, `projectMembers/${pid}`));
    await remove(ref(db, `userProjects/${currentUid}/${pid}`));
    toast("Project deleted");
    currentProjectId=null;
    await loadProjects();
  }catch(e){toast(e.message)}
});

</script>
</body>
</html>
