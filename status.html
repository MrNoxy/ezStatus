<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#161b22"/>
<meta name="description" content="Public status page"/>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg ' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2300c17c'/></svg>"/>
<title>Status</title>

<style>
:root{
  --bg:#000000;--card:#161b22;--card2:#11141e;--tooltip:#11141e;
  --border:#30363d;--text:#c9d1d9;--subtle:#8b949e;--accent:#58a6ff;
  --ok:#00c17c;--down:#d2344e;--warning:#f0a500;--paused:#f0de4e;
  --maintenance:#6a42f5;--unknown:#777;--unlinked:#2a2f38;
  --radius:12px;--gap:24px;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
/* ----  BUILT-IN THEMES  ---- */
[data-theme="light"]{
  --bg:#ffffff;--card:#f6f8fa;--card2:#f6f8fa;--tooltip:#f6f8fa;
  --border:#d0d7de;--text:#24292f;--subtle:#656d76;--accent:#0969da;
  --ok:#1a7f37;--down:#d1242f;--warning:#d4a72c;--paused:#bf8700;
  --maintenance:#8250df;--unknown:#656d76;--unlinked:#ebf0f4;
}
[data-theme="dark-purple"]{
  --bg:#0b0514;--card:#1f0e33;--card2:#180b26;--tooltip:#180b26;
  --border:#3c1e5c;--text:#e2d5f3;--subtle:#a18daf;--accent:#a78bfa;
  --ok:#34d399;--down:#f87272;--warning:#fbbf24;--paused:#fde047;
  --maintenance:#c084fc;--unknown:#6b7280;--unlinked:#382e4e;
}
[data-theme="green"]{
  --bg:#021a03;--card:#063a06;--card2:#042b04;--tooltip:#042b04;
  --border:#166416;--text:#dcfce7;--subtle:#a7f3d0;--accent:#4ade80;
  --ok:#22c55e;--down:#ef4444;--warning:#f59e0b;--paused:#fcd34d;
  --maintenance:#818cf8;--unknown:#6b7280;--unlinked:#1f3320;
}
[data-theme="blue"]{
  --bg:#00172a;--card:#003355;--card2:#002944;--tooltip:#002944;
  --border:#005c99;--text:#e0f2fe;--subtle:#7dd3fc;--accent:#38bdf8;
  --ok:#22d3ee;--down:#f43f5e;--warning:#facc15;--paused:#fde047;
  --maintenance:#818cf8;--unknown:#64748b;--unlinked:#1e4066;
}
/* ... keeping other themes concise for brevity, add them back if needed ... */

body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font);display:flex;flex-direction:column;align-items:center;padding:40px 0}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

.header{width:780px;max-width:95%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.brand{display:flex;flex-direction:column;gap:4px}
.brand h1{margin:0;font-size:18px}
.brand .sub{color:var(--subtle);font-size:13px}
.project-pill{display:inline-flex;gap:10px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px}
.project-pill code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:var(--subtle)}

.theme-switcher{position:fixed;right:12px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:6px;z-index:2000}
.theme-btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;transition:border-color .2s}
.theme-btn:hover{border-color:var(--accent)}
.offline-banner{display:none;position:sticky;top:0;width:100%;background:var(--down);color:#fff;text-align:center;padding:8px;font-size:13px;z-index:1500}

#generalStatusBar{width:780px;max-width:95%;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;display:flex;flex-direction:column;gap:10px}
#generalStatusText{display:flex;align-items:center;gap:10px;font-weight:700}
#generalStatusIcon{width:10px;height:10px;border-radius:50%}
#generalLastUpdated{color:var(--subtle);font-size:13px}
#generalAnnouncement{color:var(--warning);font-size:13px;white-space:pre-wrap;display:none}

/* CONTROLS (New) */
.controls-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.view-select{background:var(--card2);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;font-size:13px;cursor:pointer}
.view-select:focus{outline:none;border-color:var(--accent)}

.status-container{width:780px;max-width:95%;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;display:flex;flex-direction:column;gap:16px;margin-top:var(--gap)}
.app-section{display:flex;flex-direction:column;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 16px}
.top-bar{display:flex;align-items:center;gap:10px;font-weight:700;margin-bottom:6px}
.status-icon{width:10px;height:10px;border-radius:50%;background:var(--unlinked)}
.status-icon.operational{background:var(--ok)}
.status-icon.down{background:var(--down)}
.status-icon.degraded{background:var(--warning)}
.status-icon.paused{background:var(--paused)}
.status-icon.maintenance{background:var(--maintenance)}
.status-icon.unknown{background:var(--unknown)}
.status-icon.unlinked{background:var(--unlinked)}

.status-bar-container{width:100%;display:flex;flex-direction:column;gap:6px}
.status-bar{display:flex;gap:3px;justify-content:space-between}
.day-labels{display:flex;justify-content:space-between;font-size:11px;color:var(--subtle);margin-top:2px}

/* Updated Bar Box for responsive fitting */
.bar-box{
  flex:1;
  height:24px;
  border-radius:4px;
  background:var(--unlinked);
  cursor:pointer;
  transition:transform .1s ease, opacity .1s;
  min-width: 4px; /* Ensure they don't disappear on small screens */
}
.bar-box.operational{background:var(--ok)}
.bar-box.down{background:var(--down)}
.bar-box.degraded{background:var(--warning)}
.bar-box.paused{background:var(--paused)}
.bar-box.maintenance{background:var(--maintenance)}
.bar-box.unknown{background:var(--unknown)}
.bar-box.unlinked{background:var(--unlinked); opacity: 0.5;} /* Visually distinguish unlinked */

.bar-box:hover{transform:scaleY(1.15); opacity:1}

#statusTooltip{position:fixed;background:var(--tooltip);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;font-size:13px;pointer-events:none;opacity:0;transition:opacity .1s;z-index:1000;max-width:280px;line-height:1.4;box-shadow:0 4px 12px rgba(0,0,0,0.3)}

/* Timeline */
.timeline-container{width:780px;max-width:95%;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-top:var(--gap);animation:fadeIn .5s ease}
.timeline-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--gap)}
.timeline-title{font-size:18px;font-weight:700;color:var(--warning)}
.period-selector{background:var(--card2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;transition:border-color .2s}
.timeline{position:relative;padding-left:24px}
.timeline::before{content:"";position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--border)}
.timeline-item{position:relative;padding-bottom:var(--gap);animation:fadeIn .3s ease both}
.timeline-item::before{content:"";position:absolute;left:-24px;top:8px;width:12px;height:12px;border-radius:50%;background:var(--border);border:3px solid var(--bg);transform:translateX(-50%);transition:background .2s}
.timeline-item.success::before{background:var(--ok)}
.timeline-item.warning::before{background:var(--warning)}
.timeline-item.danger::before{background:var(--down)}
.timeline-item.info::before{background:var(--accent)}
.timeline-content{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:16px;transition:border-color .2s,box-shadow .2s}
.timeline-content:hover{border-color:var(--accent);box-shadow:0 4px 12px rgba(0,0,0,.2)}
.timeline-time{font-size:12px;color:var(--subtle);margin-bottom:6px;font-weight:500}
.timeline-title{font-weight:600;margin-bottom:6px;font-size:15px}
.timeline-description{color:var(--subtle);font-size:14px;line-height:1.5;white-space:pre-wrap}
.timeline-meta{display:flex;gap:12px;margin-top:8px;font-size:12px;color:var(--subtle)}
.timeline-badge{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:4px 8px;font-size:11px;font-weight:600}
.copy-btn{margin-left:auto;background:0 0;border:none;color:var(--accent);cursor:pointer;font-size:12px}

@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
@media (max-width:800px){
  body{padding:24px 0}
  #generalStatusBar,.status-container,.timeline-container{width:95%}
}
</style>
</head>
<body>

<div class="offline-banner" id="offlineBanner">You‚Äôre offline ‚Äì data may be stale</div>

<div class="theme-switcher" aria-label="Theme switcher">
  <button class="theme-btn" data-theme="dark" title="Dark">üåô</button>
  <button class="theme-btn" data-theme="light" title="Light">‚òÄÔ∏è</button>
  <button class="theme-btn" data-theme="blue" title="Blue">üîµ</button>
  <button class="theme-btn" data-theme="green" title="Green">üü¢</button>
</div>

<div class="header">
  <div class="brand">
    <h1 id="projectName">Loading‚Ä¶</h1>
    <div class="sub" id="projectSubtitle">Public status</div>
  </div>
  <div class="project-pill" title="Project reference">
    <span>Project</span>
    <code id="projectRef">‚Äî</code>
  </div>
</div>

<div id="generalStatusBar" role="region" aria-label="General status">
  <div id="generalStatusText">
    <div id="generalStatusIcon" aria-hidden="true"></div>
    <span id="generalStatusLabel">Loading status‚Ä¶</span>
  </div>
  <div id="generalLastUpdated" aria-live="polite">Loading update time‚Ä¶</div>
  <div id="generalAnnouncement" role="note"></div>
</div>

<div class="status-container" id="statusContainer" role="region" aria-label="Services status">
  <div class="controls-header">
    <div style="font-weight:700;font-size:14px">System Status</div>
    <select id="statusViewRange" class="view-select" aria-label="Status Range">
      <option value="24h">Last 24 Hours</option>
      <option value="7d">Last 7 Days</option>
      <option value="30d">Last 30 Days</option>
      </select>
  </div>
  <div id="servicesList">
    <div class="app-section">
      <div class="top-bar"><span class="status-icon"></span><span>Loading‚Ä¶</span></div>
    </div>
  </div>
</div>

<div class="timeline-container" role="region" aria-label="Recent activity">
  <div class="timeline-header">
    <h2 class="timeline-title">Recent Activity</h2>
    <select class="period-selector" id="activityPeriod" aria-label="Select time period">
      <option value="24h">Last 24 hours</option>
      <option value="7d" selected>Last 7 days</option>
      <option value="30d">Last 30 days</option>
    </select>
  </div>
  <div class="timeline" id="activityTimeline" aria-live="polite"></div>
  <div id="loadMore" style="text-align:center;padding:12px;color:var(--subtle);cursor:pointer;display:none;">Load more</div>
</div>

<div id="statusTooltip" role="tooltip"></div>

<script type="module">
import { app, auth, db } from "./firebase.js";
import {
  ref, onValue, get, query, orderByChild, equalTo, limitToFirst
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const $ = q => document.querySelector(q);
const copyText = str => navigator.clipboard?.writeText(str).catch(()=>{});
const timeAgo = ts=>{
  const sec=Math.floor((Date.now()-ts)/1000);
  if(sec<60)return`${sec}s ago`;
  const min=Math.floor(sec/60);
  if(min<60)return`${min}m ago`;
  const h=Math.floor(min/60);
  if(h<24)return`${h}h ago`;
  const d=Math.floor(h/24);
  return`${d} day${d>1?'s':''} ago`;
};

/* ----------  theme switcher  ---------- */
document.addEventListener('click', e=>{
  if(!e.target.matches('.theme-btn')) return;
  const th = e.target.dataset.theme;
  document.documentElement.setAttribute('data-theme', th);
  localStorage.setItem('theme', th);
});
(()=>{
  const th = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', th);
})();

window.addEventListener('online', ()=> $('#offlineBanner').style.display='none');
window.addEventListener('offline', ()=> $('#offlineBanner').style.display='block');

const STATUS_NAMES = { operational:'Operational', down:'Down', degraded:'Degraded', paused:'Paused', maintenance:'Maintenance', unknown:'Unknown', unlinked:'No Data' };
const STATUS_PRIORITY = { down:10, degraded:5, maintenance:3, paused:2, operational:1, unknown:0, unlinked:0 };

const tip = $('#statusTooltip');
function showTooltip(e, html){ tip.innerHTML = html; tip.style.opacity='1'; positionTooltip(e); }
function hideTooltip(){ tip.style.opacity='0'; }
function positionTooltip(e){
  const pad=12; let x=e.clientX+pad, y=e.clientY+pad;
  const r=tip.getBoundingClientRect();
  if(x+r.width+pad>window.innerWidth) x=e.clientX-r.width-pad;
  if(y+r.height+pad>window.innerHeight) y=e.clientY-r.height-pad;
  tip.style.left = x+'px'; tip.style.top  = y+'px';
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ================== CORE LOGIC ================== */

// Convert db history keys (YYYY-MM-DD or YYYY-MM-DDTHH:mm) to timestamp number
function parseKey(k){
  if(k.includes('T')) return new Date(k).getTime();
  return new Date(k + 'T00:00:00').getTime(); // Assume start of day
}

// Get the effective status at a specific point in time
// loops backwards to find the last set status.
function getStatusAtTime(history, targetTime){
  if(!history) return 'operational'; // Default if no history at all
  
  // Convert history to array [ {ts, status} ] sorted by time
  const entries = Object.entries(history).map(([k,v])=>{
    let st = (typeof v==='string') ? v : (v.status||'unknown');
    return { ts: parseKey(k), status: st };
  }).sort((a,b)=>a.ts - b.ts);

  // Find the closest entry <= targetTime
  let currentStatus = 'operational'; // Default base state
  for(const e of entries){
    if(e.ts <= targetTime){
      currentStatus = e.status;
    } else {
      break; // Future entries don't affect this moment
    }
  }
  return currentStatus;
}

function generateTimeSlices(range){
  const slices = [];
  const now = Date.now();
  
  if(range === '24h'){
    // Generate last 24 hours (hourly buckets)
    // Round 'now' down to nearest hour
    const currentHour = new Date(); 
    currentHour.setMinutes(0,0,0);
    const endTs = currentHour.getTime();
    
    for(let i=23; i>=0; i--){
      const ts = endTs - (i * 3600000);
      slices.push({
        ts: ts,
        label: new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
        fullDate: new Date(ts).toLocaleString()
      });
    }
  } else {
    // Days (7d, 30d, 90d)
    const days = range==='7d'?7 : (range==='30d'?30 : 90);
    const today = new Date(); 
    today.setHours(0,0,0,0);
    const endTs = today.getTime();
    
    for(let i=days-1; i>=0; i--){
      const ts = endTs - (i * 86400000);
      slices.push({
        ts: ts,
        label: new Date(ts).toLocaleDateString(undefined, {month:'short', day:'numeric'}),
        fullDate: new Date(ts).toLocaleDateString(undefined, {weekday:'short', year:'numeric', month:'long', day:'numeric'})
      });
    }
  }
  return slices;
}

function renderBars(service, range){
  const slices = generateTimeSlices(range);
  const boxes = slices.map(slice => {
    // We check status at the END of the slice duration to be safe, 
    // or arguably at the START. Let's use the slice timestamp.
    // However, if data is stored as "2023-01-01", it acts as 00:00.
    // If we request status for 10:00 AM, it should pick up the 00:00 status.
    const st = getStatusAtTime(service.history, slice.ts);
    
    // Determine class
    const cls = st === 'operational' ? 'operational' : st;
    
    return `<div class="bar-box ${cls}" 
                data-status="${st}" 
                data-date="${slice.fullDate}" 
                data-label="${slice.label}"
                aria-label="${slice.label}: ${STATUS_NAMES[st]}"></div>`;
  });

  // Labels for start and end
  const startLabel = slices[0].label;
  const endLabel = range==='24h' ? 'Now' : 'Today';

  return `
    <div class="status-bar-container">
      <div class="status-bar">${boxes.join('')}</div>
      <div class="day-labels">
        <span>${startLabel}</span>
        <span>${endLabel}</span>
      </div>
    </div>
  `;
}

function renderServiceSection(service, range){
  const currentStatus = getStatusAtTime(service.history, Date.now());
  const cls = currentStatus==='operational'?'operational':currentStatus;
  
  return `<div class="app-section">
    <div class="top-bar">
      <span class="status-icon ${cls}" aria-hidden="true"></span>
      <span>${escapeHtml(service.name||'Unnamed Service')}</span>
    </div>
    ${renderBars(service, range)}
  </div>`;
}

function updateGeneralStatus(services){
  const icon=$('#generalStatusIcon'), label=$('#generalStatusLabel'), last=$('#generalLastUpdated');
  const list = Object.values(services||{});
  
  if(list.length===0){ label.textContent='No services available'; icon.style.backgroundColor='#777'; last.textContent=''; return; }

  // Check CURRENT status of all services
  const now = Date.now();
  const statusSet = new Set();
  let newestUpdate = 0;

  list.forEach(s=>{
    if(s.lastUpdated && s.lastUpdated > newestUpdate) newestUpdate = s.lastUpdated;
    const st = getStatusAtTime(s.history, now);
    statusSet.add(st);
  });

  const statuses = [...statusSet];
  
  // Hierarchy of badness
  if(statuses.includes('down')) icon.style.backgroundColor='var(--down)';
  else if(statuses.includes('degraded')) icon.style.backgroundColor='var(--warning)';
  else if(statuses.includes('paused')) icon.style.backgroundColor='var(--paused)';
  else if(statuses.includes('maintenance')) icon.style.backgroundColor='var(--maintenance)';
  else icon.style.backgroundColor='var(--ok)';

  const badOnes = statuses.filter(s => s !== 'operational' && s !== 'unknown');

  if(badOnes.length === 0){
    label.textContent = 'All systems operational';
  } else {
    const readable = {down:'down', degraded:'degraded', paused:'paused', maintenance:'under maintenance'};
    const statusWords = badOnes.map(s => readable[s] || s);
    label.textContent = `Some services are ${statusWords.join(', ')}`;
  }
  
  last.textContent = newestUpdate ? `Last updated ${timeAgo(newestUpdate)}` : '';
}

function updateAnnouncement(text){
  const el=$('#generalAnnouncement');
  if(text?.trim()){ el.style.display='block'; el.textContent=text; } else el.style.display='none';
}

/* ----- Timeline (Recent Activity) ----- */
let timelineAll = [];
let timelineRendered = 0;
const PER_PAGE = 25;

function buildMasterTimeline(services, period){
  const hoursMap = { '24h':24, '7d':168, '30d':720, '90d':2160 };
  const hrs = hoursMap[period] || 168;
  const now = Date.now();
  const ev = [];

  Object.values(services||{}).forEach(s=>{
    if(!s.history) return;
    Object.entries(s.history).forEach(([k,val])=>{
      // Try to determine timestamp of event
      let t = parseKey(k);
      // If object has explicit timestamp, prefer that
      if(typeof val === 'object' && val.timestamp) t = val.timestamp;
      
      if((now - t)/36e5 > hrs) return; // filter by range

      const st = (typeof val==='string') ? val : (val.status||'unknown');
      const note = (typeof val==='object') ? (val.notes||'') : '';
      const ver  = (typeof val==='object') ? (val.version||'N/A') : 'N/A';
      
      // Determine color
      const type = st==='down'?'danger':st==='degraded'?'warning':st==='maintenance'?'info':'success';
      
      ev.push({
        type, time: t,
        title: `${s.name} ‚Äì ${STATUS_NAMES[st]||st}`,
        description: note || `Status set to ${st}`,
        service: s.name, version: ver
      });
    });
  });

  ev.sort((a,b)=>b.time - a.time);
  timelineAll = ev;
  timelineRendered = 0;
}

function renderNextTimelineSlice(){
  const slice = timelineAll.slice(timelineRendered, timelineRendered+PER_PAGE);
  const tl = $('#activityTimeline');
  
  if(slice.length===0 && timelineRendered===0){
    tl.innerHTML = '<div style="color:var(--subtle);padding:10px">No recent activity.</div>';
    $('#loadMore').style.display='none';
    return;
  }
  
  const html = slice.map((e,i)=>`
    <div class="timeline-item ${e.type}" style="animation-delay:${(i)*.03}s">
      <div class="timeline-content">
        <div class="timeline-time">${new Date(e.time).toLocaleString()} (${timeAgo(e.time)})</div>
        <div class="timeline-title">${escapeHtml(e.title)}</div>
        <div class="timeline-description">${escapeHtml(e.description)}</div>
        <div class="timeline-meta">
          <span class="timeline-badge">${escapeHtml(e.service)}</span>
          ${e.version!=='N/A'?`<span class="timeline-badge">v${escapeHtml(e.version)}</span>`:''}
          <button class="copy-btn" data-copy="${escapeHtml(e.title)}">Copy</button>
        </div>
      </div>
    </div>
  `).join('');
  
  tl.insertAdjacentHTML('beforeend', html);
  
  tl.querySelectorAll('.copy-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      copyText(btn.dataset.copy);
      const old=btn.textContent; btn.textContent='Copied';
      setTimeout(()=>btn.textContent=old, 1000);
    });
  });
  
  timelineRendered += slice.length;
  $('#loadMore').style.display = (timelineRendered >= timelineAll.length) ? 'none' : 'block';
}

$('#loadMore').addEventListener('click', renderNextTimelineSlice);
$('#activityPeriod').addEventListener('change', refreshTimeline);

function refreshTimeline(){
  const per = $('#activityPeriod').value;
  const services = window.__lastServices || {};
  $('#activityTimeline').innerHTML = '';
  buildMasterTimeline(services, per);
  renderNextTimelineSlice();
}

/* ----- Tooltip Logic for Bars ----- */
function mountServiceBars(){
  const container = $('#servicesList');
  container.querySelectorAll('.bar-box').forEach(b=>{
    b.addEventListener('mouseenter', e=>{
      const st = e.target.dataset.status;
      const date = e.target.dataset.date; // full text date
      const label = e.target.dataset.label; // short label
      
      const readable = STATUS_NAMES[st] || st;
      showTooltip(e, `<strong>${date}</strong><br><span style="text-transform:capitalize">${readable}</span>`);
    });
    b.addEventListener('mousemove', positionTooltip);
    b.addEventListener('mouseleave', hideTooltip);
  });
}

/* ----- View Range Switcher ----- */
$('#statusViewRange').addEventListener('change', ()=>{
  const range = $('#statusViewRange').value;
  const services = window.__lastServices || {};
  renderAllServices(services, range);
});

function renderAllServices(services, range){
  const list = Object.values(services);
  const container = $('#servicesList');
  
  if(!list.length){
    container.innerHTML = '<div class="app-section" style="text-align:center;color:var(--subtle);padding:28px">No services yet.</div>';
    return;
  }
  
  container.innerHTML = list
    .sort((a,b)=>(a.order??0)-(b.order??0))
    .map(s => renderServiceSection(s, range))
    .join('');
    
  mountServiceBars();
}

/* ----- Init ----- */
function getProjectParam(){
  const u = new URL(location.href);
  return (u.searchParams.get('project') || '').trim();
}
async function resolveProjectId(projectParam){
  if(!projectParam) return null;
  if(projectParam.startsWith("-")) return projectParam;
  const slugSnap = await get(ref(db, `projectSlugs/${projectParam}`));
  return slugSnap.val();
}

(async function boot(){
  const param = getProjectParam();
  const projectId = await resolveProjectId(param);
  
  if(!projectId){
    $('#projectName').textContent = "Project not found";
    $('#projectSubtitle').innerHTML = `Add <code>?project=YOUR_SLUG</code> to the URL.`;
    return;
  }
  
  $('#projectRef').textContent = projectId;

  // Meta
  onValue(ref(db, `projects/${projectId}`), snap=>{
    const p = snap.val();
    if(!p) return;
    $('#projectName').textContent = p.name || "Status";
    $('#projectSubtitle').textContent = p.public ? "Public status" : "Private";
  });

  // Announcement
  onValue(ref(db, `announcements/${projectId}`), snap=>{
    const ann = snap.val() || {};
    updateAnnouncement(ann.text || '');
  });

  // Services
  onValue(ref(db, `services/${projectId}`), snap=>{
    const services = snap.val() || {};
    window.__lastServices = services;
    
    // Default render
    const currentRange = $('#statusViewRange').value;
    renderAllServices(services, currentRange);
    
    updateGeneralStatus(services);
    refreshTimeline();
  });
})();
</script>
</body>
</html>