<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#161b22"/>
<meta name="description" content="Public status page"/>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg ' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2300c17c'/></svg>"/>
<title>Status</title>

<style>
/* (Your original look, mostly preserved) */
:root{
  --bg:#000000;--card:#161b22;--card2:#11141e;--tooltip:#11141e;
  --border:#30363d;--text:#c9d1d9;--subtle:#8b949e;--accent:#58a6ff;
  --ok:#00c17c;--down:#d2344e;--warning:#f0a500;--paused:#f0de4e;
  --maintenance:#6a42f5;--unknown:#777;--unlinked:#555a66;
  --radius:12px;--gap:24px;
  --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
/* ----  BUILT-IN THEMES  ---- */
[data-theme="light"]{
  --bg:#ffffff;--card:#f6f8fa;--card2:#f6f8fa;--tooltip:#f6f8fa;
  --border:#d0d7de;--text:#24292f;--subtle:#656d76;--accent:#0969da;
  --ok:#1a7f37;--down:#d1242f;--warning:#d4a72c;--paused:#bf8700;
  --maintenance:#8250df;--unknown:#656d76;--unlinked:#8c959f;
}
[data-theme="dark-purple"]{
  --bg:#0b0514;--card:#1f0e33;--card2:#180b26;--tooltip:#180b26;
  --border:#3c1e5c;--text:#e2d5f3;--subtle:#a18daf;--accent:#a78bfa;
  --ok:#34d399;--down:#f87272;--warning:#fbbf24;--paused:#fde047;
  --maintenance:#c084fc;--unknown:#6b7280;--unlinked:#4b5563;
}
[data-theme="green"]{
  --bg:#021a03;--card:#063a06;--card2:#042b04;--tooltip:#042b04;
  --border:#166416;--text:#dcfce7;--subtle:#a7f3d0;--accent:#4ade80;
  --ok:#22c55e;--down:#ef4444;--warning:#f59e0b;--paused:#fcd34d;
  --maintenance:#818cf8;--unknown:#6b7280;--unlinked:#4b5563;
}
[data-theme="blue"]{
  --bg:#00172a;--card:#003355;--card2:#002944;--tooltip:#002944;
  --border:#005c99;--text:#e0f2fe;--subtle:#7dd3fc;--accent:#38bdf8;
  --ok:#22d3ee;--down:#f43f5e;--warning:#facc15;--paused:#fde047;
  --maintenance:#818cf8;--unknown:#64748b;--unlinked:#475569;
}
[data-theme="dark-rosa"]{
  --bg:#1c0615;--card:#3b0f2b;--card2:#2e0b22;--tooltip:#2e0b22;
  --border:#6b1d4f;--text:#fce7f3;--subtle:#f9a8d4;--accent:#f472b6;
  --ok:#34d399;--down:#fb7185;--warning:#fbbf24;--paused:#fde047;
  --maintenance:#c084fc;--unknown:#6b7280;--unlinked:#4b5563;
}
[data-theme="light-rosa"]{
  --bg:#fff1f2;--card:#ffe4e6;--card2:#fed7da;--tooltip:#fed7da;
  --border:#fda4af;--text:#881337;--subtle:#f43f5e;--accent:#ec4899;
  --ok:#10b981;--down:#e11d48;--warning:#f59e0b;--paused:#fcd34d;
  --maintenance:#8b5cf6;--unknown:#9ca3af;--unlinked:#6b7280;
}
[data-theme="halloween"]{
  --bg:#1c110a;--card:#3a200f;--card2:#2c180a;--tooltip:#2c180a;
  --border:#7c3f0f;--text:#fbbf24;--subtle:#fdba74;--accent:#f97316;
  --ok:#84cc16;--down:#dc2626;--warning:#f59e0b;--paused:#fde047;
  --maintenance:#a855f7;--unknown:#6b7280;--unlinked:#4b5563;
}
[data-theme="christmas"]{
  --bg:#0f1a0f;--card:#1a3a1a;--card2:#122912;--tooltip:#122912;
  --border:#166534;--text:#dcfce7;--subtle:#86efac;--accent:#22c55e;
  --ok:#22c55e;--down:#ef4444;--warning:#fbbf24;--paused:#fde047;
  --maintenance:#818cf8;--unknown:#6b7280;--unlinked:#4b5563;
}
[data-theme="hack"]{
  --bg:#000;--card:#0d0d0d;--card2:#0a0a0a;--tooltip:#0a0a0a;
  --border:#00ff00;--text:#00ff00;--subtle:#39ff14;--accent:#00ff41;
  --ok:#00ff00;--down:#ff073a;--warning:#ffaa00;--paused:#fff500;
  --maintenance:#0ff;--unknown:#7c7c7c;--unlinked:#555;
}
[data-theme="neon"]{
  --bg:#0d0221;--card:#1d1033;--card2:#160b26;--tooltip:#160b26;
  --border:#6e44ff;--text:#f0f;--subtle:#ff44cc;--accent:#00f7ff;
  --ok:#00ff89;--down:#ff2a6d;--warning:#ffe74c;--paused:#f5ff90;
  --maintenance:#05d9e8;--unknown:#8c8c8c;--unlinked:#555;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font);display:flex;flex-direction:column;align-items:center;padding:40px 0}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

.header{width:780px;max-width:95%;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
.brand{display:flex;flex-direction:column;gap:4px}
.brand h1{margin:0;font-size:18px}
.brand .sub{color:var(--subtle);font-size:13px}
.project-pill{display:inline-flex;gap:10px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px}
.project-pill code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;color:var(--subtle)}

.theme-switcher{position:fixed;right:12px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:6px;z-index:2000}
.theme-btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;transition:border-color .2s}
.theme-btn:hover{border-color:var(--accent)}
.offline-banner{display:none;position:sticky;top:0;width:100%;background:var(--down);color:#fff;text-align:center;padding:8px;font-size:13px;z-index:1500}

#generalStatusBar{width:780px;max-width:95%;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;display:flex;flex-direction:column;gap:10px}
#generalStatusText{display:flex;align-items:center;gap:10px;font-weight:700}
#generalStatusIcon{width:10px;height:10px;border-radius:50%}
#generalLastUpdated{color:var(--subtle);font-size:13px}
#generalAnnouncement{color:var(--warning);font-size:13px;white-space:pre-wrap;display:none}

.status-container{width:780px;max-width:95%;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;display:flex;flex-direction:column;gap:16px;margin-top:var(--gap)}
.app-section{display:flex;flex-direction:column;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 16px}
.top-bar{display:flex;align-items:center;gap:10px;font-weight:700;margin-bottom:10px}
.status-icon{width:10px;height:10px;border-radius:50%;background:var(--unlinked)}
.status-icon.operational{background:var(--ok)}
.status-icon.down{background:var(--down)}
.status-icon.degraded{background:var(--warning)}
.status-icon.paused{background:var(--paused)}
.status-icon.maintenance{background:var(--maintenance)}
.status-icon.unknown{background:var(--unknown)}
.status-icon.unlinked{background:var(--unlinked)}

.status-bar-container{width:780px;max-width:95%;display:flex;flex-direction:column;gap:4px}
.status-bar{display:flex;width:100%}
.day-labels{display:flex;gap:3px;font-size:12px;color:var(--subtle)}
.day-label{width:48px;text-align:center}
.label-start,.label-end{font-weight:600;color:var(--text)}
.bar-box{flex:1 1 0;height:14px;border-radius:4px;background:var(--ok);cursor:pointer;transition:transform .15s ease,box-shadow .15s ease;min-width:0}
.bar-box.down{background:var(--down)}
.bar-box.degraded{background:var(--warning)}
.bar-box.paused{background:var(--paused)}
.bar-box.maintenance{background:var(--maintenance)}
.bar-box.unknown{background:var(--unknown)}
.bar-box.unlinked{background:var(--unlinked)}
.bar-box:hover{transform:scale(1.05)}
#statusTooltip{position:fixed;background:var(--tooltip);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;font-size:13px;pointer-events:none;opacity:0;transition:opacity .15s;z-index:1000;max-width:280px;line-height:1.4}

/* --------------  RECENT ACTIVITY  ‚Äì‚Äì  infinite scroll  -------------- */
.timeline-container{width:780px;max-width:95%;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-top:var(--gap);animation:fadeIn .5s ease}
.timeline-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--gap)}
.timeline-title{font-size:18px;font-weight:700;color:var(--warning)}
.period-selector{background:var(--card2);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer;transition:border-color .2s}
.period-selector:hover{border-color:var(--accent)}
.period-selector:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(88,166,255,.1)}
.timeline{position:relative;padding-left:24px}
.timeline::before{content:"";position:absolute;left:0;top:0;bottom:0;width:2px;background:var(--border)}
.timeline-item{position:relative;padding-bottom:var(--gap);animation:fadeIn .3s ease both}
.timeline-item::before{content:"";position:absolute;left:-24px;top:8px;width:12px;height:12px;border-radius:50%;background:var(--border);border:3px solid var(--bg);transform:translateX(-50%);transition:background .2s}
.timeline-item.success::before{background:var(--ok)}
.timeline-item.warning::before{background:var(--warning)}
.timeline-item.danger::before{background:var(--down)}
.timeline-item.info::before{background:var(--accent)}
.timeline-content{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:16px;transition:border-color .2s,box-shadow .2s}
.timeline-content:hover{border-color:var(--accent);box-shadow:0 4px 12px rgba(0,0,0,.2)}
.timeline-time{font-size:12px;color:var(--subtle);margin-bottom:6px;font-weight:500}
.timeline-title{font-weight:600;margin-bottom:6px;font-size:15px}
.timeline-description{color:var(--subtle);font-size:14px;line-height:1.5;white-space:pre-wrap}
.timeline-meta{display:flex;gap:12px;margin-top:8px;font-size:12px;color:var(--subtle)}
.timeline-badge{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:4px 8px;font-size:11px;font-weight:600}
.timeline-badge.success{background:rgba(0,193,124,.1);border-color:var(--ok);color:var(--ok)}
.timeline-badge.warning{background:rgba(240,165,0,.1);border-color:var(--warning);color:var(--warning)}
.timeline-badge.danger{background:rgba(210,52,78,.1);border-color:var(--down);color:var(--down)}
.timeline-badge.info{background:rgba(88,166,255,.1);border-color:var(--accent);color:var(--accent)}
.copy-btn{margin-left:auto;background:0 0;border:none;color:var(--accent);cursor:pointer;font-size:12px}
.copy-btn:hover{text-decoration:underline}

/* --- Uptime bars layout (hourly + daily, BetterStack-like spacing) --- */
.status-bar.hourly{gap:2px}
.status-bar.daily{gap:4px}
.day-labels.hourly{justify-content:space-between}
.day-labels.hourly .day-label{width:auto;flex:0 0 auto;text-align:left}
/* Optional: subtle day divider for 120h (every 24 hours) */
.status-bar.hourly .bar-box:nth-child(24n){margin-right:6px}


@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
@media (max-width:800px){
  body{padding:24px 0}
  #generalStatusBar,.status-container,.timeline-container{width:95%}
}
</style>
</head>
<body>

<div class="offline-banner" id="offlineBanner">You‚Äôre offline ‚Äì data may be stale</div>

<!--  vertical theme switcher  -->
<div class="theme-switcher" aria-label="Theme switcher">
  <button class="theme-btn" data-theme="dark" title="Dark">üåô</button>
  <button class="theme-btn" data-theme="light" title="Light">‚òÄÔ∏è</button>
  <button class="theme-btn" data-theme="dark-purple" title="Dark Purple">üü£</button>
  <button class="theme-btn" data-theme="green" title="Green">üü¢</button>
  <button class="theme-btn" data-theme="blue" title="Blue">üîµ</button>
  <button class="theme-btn" data-theme="dark-rosa" title="Dark Rosa">üå∏</button>
  <button class="theme-btn" data-theme="light-rosa" title="Light Rosa">üíó</button>
  <button class="theme-btn" data-theme="halloween" title="Halloween">üéÉ</button>
  <button class="theme-btn" data-theme="christmas" title="Christmas">üéÑ</button>
  <button class="theme-btn" data-theme="hack" title="Hack">üëæ</button>
  <button class="theme-btn" data-theme="neon" title="Neon">üåÜ</button>
</div>

<div class="header">
  <div class="brand">
    <h1 id="projectName">Loading‚Ä¶</h1>
    <div class="sub" id="projectSubtitle">Public status</div>
  </div>
  <div class="project-pill" title="Project reference">
    <span>Project</span>
    <code id="projectRef">‚Äî</code>
  </div>
</div>

<div id="generalStatusBar" role="region" aria-label="General status">
  <div id="generalStatusText">
    <div id="generalStatusIcon" aria-hidden="true"></div>
    <span id="generalStatusLabel">Loading status‚Ä¶</span>
  </div>
  <div id="generalLastUpdated" aria-live="polite">Loading update time‚Ä¶</div>
  <div id="generalAnnouncement" role="note"></div>
</div>

<div class="status-container" id="statusContainer" role="region" aria-label="Services status">
  <div class="timeline-header" style="margin-bottom:12px;">
    <h2 class="timeline-title" style="color:var(--text);">Uptime</h2>
    <select class="period-selector" id="uptimePeriod" aria-label="Select uptime graph period">
      <option value="120h" selected>Last 120 hours</option>
      <option value="14d">Last 14 days</option>
      <option value="30d">Last 30 days</option>
      <option value="60d">Last 60 days</option>
      <option value="90d">Last 90 days</option>
      <option value="120d">Last 120 days</option>
    </select>
  </div>
  <div class="app-section">
    <div class="top-bar"><span class="status-icon"></span><span>Loading‚Ä¶</span></div>
    <div class="status-bar-container">
      <div class="status-bar">
        <div class="bar-box unlinked"></div><div class="bar-box unlinked"></div><div class="bar-box unlinked"></div>
        <div class="bar-box unlinked"></div><div class="bar-box unlinked"></div>
      </div>
    </div>
  </div>
</div>

<div class="timeline-container" role="region" aria-label="Recent activity">
  <div class="timeline-header">
    <h2 class="timeline-title">Recent Activity</h2>
    <select class="period-selector" id="activityPeriod" aria-label="Select time period">
      <option value="24h">Last 24 hours</option>
      <option value="7d" selected>Last 7 days</option>
      <option value="30d">Last 30 days</option>
      <option value="90d">Last 90 days</option>
      <option value="120d">Last 120 days</option>
    </select>
  </div>
  <div class="timeline" id="activityTimeline" aria-live="polite"></div>
  <div id="loadMore" style="text-align:center;padding:12px;color:var(--subtle);cursor:pointer;display:none;">Load more</div>
</div>

<div id="statusTooltip" role="tooltip"></div>

<!-- Firebase (modular) -->
<script type="module">
import { app, auth, db } from "./firebase.js";
import {
  ref, onValue, get, query, orderByChild, equalTo, limitToFirst
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const $ = q => document.querySelector(q);
const copyText = str => navigator.clipboard?.writeText(str).catch(()=>{});
const timeAgo = ts=>{
  const sec=Math.floor((Date.now()-ts)/1000);
  if(sec<60)return`${sec}s ago`;
  const min=Math.floor(sec/60);
  if(min<60)return`${min}m ago`;
  const h=Math.floor(min/60);
  if(h<24)return`${h}h ago`;
  const d=Math.floor(h/24);
  return`${d} day${d>1?'s':''} ago`;
};

/* ----------  theme switcher  ---------- */
document.addEventListener('click', e=>{
  if(!e.target.matches('.theme-btn')) return;
  const th = e.target.dataset.theme;
  document.documentElement.setAttribute('data-theme', th);
  localStorage.setItem('theme', th);
});
(()=>{
  const th = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', th);
})();

window.addEventListener('online', ()=> $('#offlineBanner').style.display='none');
window.addEventListener('offline', ()=> $('#offlineBanner').style.display='block');

const DEFAULT_UPTIME_PERIOD = '120h';
const STATUS_NAMES = { operational:'Operational', down:'Down', degraded:'Degraded', paused:'Paused', maintenance:'Maintenance', unknown:'Unknown', unlinked:'Unlinked' };

const tip = $('#statusTooltip');
function showTooltip(e, html){ tip.innerHTML = html; tip.style.opacity='1'; positionTooltip(e); }
function hideTooltip(){ tip.style.opacity='0'; }
function positionTooltip(e){
  const pad=12; let x=e.clientX+pad, y=e.clientY+pad;
  const r=tip.getBoundingClientRect();
  if(x+r.width+pad>window.innerWidth) x=e.clientX-r.width-pad;
  if(y+r.height+pad>window.innerHeight) y=e.clientY-r.height-pad;
  tip.style.left = x+'px'; tip.style.top  = y+'px';
}

function periodToHours(p){
  return {
    '120h':120,
    '14d':14*24,
    '30d':30*24,
    '60d':60*24,
    '90d':90*24,
    '120d':120*24,
    // keep compatibility with older values if they appear in URLs/localStorage
    '24h':24,
    '48h':48,
    '7d':7*24
  }[p] || 120;
}

function formatUptimeLabel(hrs){
  if(hrs===120) return '120h ago';
  if(hrs===24) return '24h ago';
  if(hrs===48) return '48h ago';
  if(hrs%24===0) return `${hrs/24}d ago`;
  return `${hrs}h ago`;
}

function floorToHour(ts){ return Math.floor(ts/36e5)*36e5; }

function getServiceChanges(service){
  const out=[];
  // New hourly history: { [hourTs]: {status, timestamp, notes, version} }
  if(service.historyHours){
    Object.entries(service.historyHours).forEach(([k,v])=>{
      const t = Number(k);
      if(!Number.isFinite(t)) return;
      const st = (typeof v==='string') ? v : (v?.status||'unknown');
      const note = (typeof v==='object') ? (v?.notes||'') : '';
      const ver  = (typeof v==='object') ? (v?.version||'') : '';
      out.push({ t, status: st, notes: note, version: ver, source: 'hour' });
    });
  }
  // Legacy daily history: { 'YYYY-MM-DD': {status,timestamp,...} }
  if(service.history){
    Object.entries(service.history).forEach(([ds,v])=>{
      const t = new Date(ds).getTime();
      const st = (typeof v==='string') ? v : (v?.status||'unknown');
      const note = (typeof v==='object') ? (v?.notes||'') : '';
      const ver  = (typeof v==='object') ? (v?.version||'') : '';
      out.push({ t, status: st, notes: note, version: ver, source: 'day' });
    });
  }
  out.sort((a,b)=>a.t-b.t);
  return out;
}

function getStatusAt(service, ts){
  const t = floorToHour(ts);
  const changes = getServiceChanges(service);
  let cur = 'unlinked';
  for(const c of changes){
    if(c.t<=t) cur = c.status;
    else break;
  }
  return cur || 'unlinked';
}

function renderBars(service){
  const period = $('#uptimePeriod')?.value || DEFAULT_UPTIME_PERIOD;
  const totalHours = periodToHours(period);
  const end = floorToHour(Date.now());
  const start = end - (totalHours-1)*36e5;

  const changes = getServiceChanges(service);
  let idx = 0;
  let cur = 'unlinked';

  // Initialize current status at the start timestamp
  while(idx < changes.length && changes[idx].t <= start){
    cur = changes[idx].status;
    idx++;
  }

  const boxes = [];

  // ===== 120 HOURS ‚Üí HOURLY (120 rectangles) =====
  if(period === '120h'){
    for(let ts = start; ts <= end; ts += 36e5){
      while(idx < changes.length && changes[idx].t <= ts){
        cur = changes[idx].status;
        idx++;
      }
      const status = cur || 'unlinked';
      const cls = status==='operational'?'operational':status;
      boxes.push(`<div class="bar-box ${cls}" data-status="${status}" data-ts="${ts}" aria-label="${new Date(ts).toLocaleString()} ${STATUS_NAMES[status]||status}"></div>`);
    }

    const labels = `
      <div class="day-labels hourly">
        <div class="day-label label-start">${formatUptimeLabel(totalHours)}</div>
        <div class="day-label label-end">Now</div>
      </div>
    `;

    return `<div class="status-bar-container"><div class="status-bar hourly">${boxes.join('')}</div>${labels}</div>`;
  }

  // ===== 14d+ ‚Üí DAILY AGGREGATION (1 rectangle/day) =====
  const days = Math.round(totalHours / 24);

  for(let d=0; d<days; d++){
    const dayStart = start + d*24*36e5;
    const dayEnd = dayStart + 24*36e5;

    // Worst-of-day: down > degraded > maintenance > paused > operational/unknown/unlinked
    let worst = 'operational';

    for(let ts = dayStart; ts < dayEnd; ts += 36e5){
      while(idx < changes.length && changes[idx].t <= ts){
        cur = changes[idx].status;
        idx++;
      }
      const st = cur || 'unlinked';
      if(st === 'down'){ worst = 'down'; break; }
      if(st === 'degraded' && worst !== 'down'){ worst = 'degraded'; }
      if(st === 'maintenance' && !['down','degraded'].includes(worst)){ worst = 'maintenance'; }
      if(st === 'paused' && !['down','degraded','maintenance'].includes(worst)){ worst = 'paused'; }
      if((st === 'unknown' || st === 'unlinked') && worst === 'operational'){ worst = st; }
    }

    const cls = worst==='operational'?'operational':worst;
    boxes.push(`<div class="bar-box ${cls}" data-status="${worst}" data-ts="${dayStart}" aria-label="${new Date(dayStart).toLocaleDateString()} ${STATUS_NAMES[worst]||worst}"></div>`);
  }

  const labels = `
    <div class="day-labels hourly">
      <div class="day-label label-start">${formatUptimeLabel(totalHours)}</div>
      <div class="day-label label-end">Now</div>
    </div>
  `;

  return `<div class="status-bar-container"><div class="status-bar daily">${boxes.join('')}</div>${labels}</div>`;
}

function renderServiceSection(service){
  const nowStatus = getStatusAt(service, Date.now());
  const cls = nowStatus==='operational'?'operational':nowStatus;
  return `<div class="app-section">
    <div class="top-bar"><span class="status-icon ${cls}" aria-hidden="true"></span><span>${escapeHtml(service.name||'Unnamed Service')}</span></div>
    ${renderBars(service)}
  </div>`;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function updateGeneralStatus(services){
  const icon=$('#generalStatusIcon'), label=$('#generalStatusLabel'), last=$('#generalLastUpdated');
  const list = Object.values(services||{});
  if(list.length===0){ label.textContent='No services available'; icon.style.backgroundColor='#777'; last.textContent=''; return; }
  const statusSet=new Set(); let newestUpdate=0;
  list.forEach(s=>{
    if(s.lastUpdated&&s.lastUpdated>newestUpdate) newestUpdate=s.lastUpdated;
    const st = getStatusAt(s, Date.now());
    if(!['unknown','unlinked',undefined].includes(st)) statusSet.add(st);
  });
  const statuses=[...statusSet];
  if(statuses.includes('down')) icon.style.backgroundColor='var(--down)';
  else if(statuses.includes('degraded')) icon.style.backgroundColor='var(--warning)';
  else if(statuses.includes('paused')) icon.style.backgroundColor='var(--paused)';
  else if(statuses.includes('maintenance')) icon.style.backgroundColor='var(--maintenance)';
  else icon.style.backgroundColor='var(--ok)';
  if(statuses.length===0||(statuses.length===1&&statuses[0]==='operational')) label.textContent='All services are online';
  else{
    const readable={down:'down',degraded:'degraded',paused:'paused',maintenance:'under maintenance'};
    const statusWords=statuses.filter(s=>s!=='operational').map(s=>readable[s]||(s.charAt(0).toUpperCase()+s.slice(1)));
    label.textContent=`Some services are ${statusWords.join(' or ')}`;
  }
  last.textContent=newestUpdate?`Last updated ${timeAgo(newestUpdate)}`:'';
}

function updateAnnouncement(text){
  const el=$('#generalAnnouncement');
  if(text?.trim()){ el.style.display='block'; el.textContent=text; } else el.style.display='none';
}

/* ----- Activity timeline (based on your original logic) ----- */
let timelineAll = [];
let timelineRendered = 0;
let lastTimelineHash = '';
let noMoreEvents = false;
const PER_PAGE = 25;

function buildMasterTimeline(services, period){
  const hrs = periodToHours(period);
  const now = Date.now();
  const ev = [];
  Object.values(services||{}).forEach(s=>{
    const pushEvent = (t, st, note, ver)=>{
      const type = st==='down'?'danger':st==='degraded'?'warning':st==='maintenance'?'info':'success';
      ev.push({
        type,
        time: t,
        title: `${s.name} ‚Äì ${STATUS_NAMES[st]||st}`,
        description: note || `Service status changed to ${st}`,
        service: s.name,
        version: ver || 'N/A'
      });
    };

    // hourly history
    if(s.historyHours){
      Object.entries(s.historyHours).forEach(([k,val])=>{
        const t = Number(k);
        if(!Number.isFinite(t)) return;
        if((now - t)/36e5 > hrs) return;
        const st = (typeof val==='string') ? val : (val.status||'unknown');
        const note = (typeof val==='object') ? (val.notes||'') : '';
        const ver  = (typeof val==='object') ? (val.version||'') : '';
        pushEvent(t, st, note, ver);
      });
    }

    // legacy daily history
    if(!s.history) return;
    Object.entries(s.history).forEach(([ds,val])=>{
      let t = new Date(ds).getTime();
      if(typeof val === 'object' && val.timestamp) t = val.timestamp;
      else if(s.lastUpdated){
        const lastUpDate = new Date(s.lastUpdated).toISOString().split('T')[0];
        if(ds===lastUpDate) t = s.lastUpdated;
      }
      if((now - t)/36e5 > hrs) return;

      const st = (typeof val==='string') ? val : (val.status||'unknown');
      const note = (typeof val==='object') ? (val.notes||'') : '';
      const ver  = (typeof val==='object') ? (val.version||'') : '';
      pushEvent(t, st, note, ver);
    });
  });
  ev.sort((a,b)=>b.time-a.time);
  timelineAll = ev;
  timelineRendered = 0;
  noMoreEvents = false;
}

function renderNextTimelineSlice(){
  if(noMoreEvents) return;
  const slice = timelineAll.slice(timelineRendered, timelineRendered+PER_PAGE);
  const tl = $('#activityTimeline');
  if(slice.length===0){ noMoreEvents=true; $('#loadMore').style.display='none'; return; }

  const html = slice.map((e,i)=>`
    <div class="timeline-item ${e.type}" style="animation-delay:${(timelineRendered+i)*.05}s">
      <div class="timeline-content">
        <div class="timeline-time">${timeAgo(e.time)}</div>
        <div class="timeline-title">${escapeHtml(e.title)}</div>
        <div class="timeline-description">${escapeHtml(e.description)}</div>
        <div class="timeline-meta">
          <span class="timeline-badge">${escapeHtml(e.service)}</span>
          ${e.version!=='N/A'?`<span class="timeline-badge">v${escapeHtml(e.version)}</span>`:''}
          <button class="copy-btn" aria-label="Copy details" data-copy="${escapeHtml(e.title)} ‚Äì ${escapeHtml(e.description)}">Copy</button>
        </div>
      </div>
    </div>
  `).join('');
  tl.insertAdjacentHTML('beforeend', html);
  tl.querySelectorAll('.copy-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      copyText(btn.dataset.copy);
      btn.textContent='Copied';
      setTimeout(()=>btn.textContent='Copy',1200);
    });
  });
  timelineRendered += slice.length;
  $('#loadMore').style.display = (timelineRendered>=timelineAll.length) ? 'none' : 'block';
  if(timelineRendered>=timelineAll.length) noMoreEvents=true;
}
$('#loadMore').addEventListener('click', renderNextTimelineSlice);
$('#activityPeriod').addEventListener('change', ()=> {
  const per = $('#activityPeriod').value;
  const services = window.__lastServices || {};
  buildMasterTimeline(services, per);
  $('#activityTimeline').innerHTML='';
  renderNextTimelineSlice();
});

$('#uptimePeriod').addEventListener('change', ()=>{
  const services = window.__lastServices || {};
  const list = Object.values(services);
  const container = $('#statusContainer');
  // Re-render sections only (preserve uptime header already in container)
  const header = container.querySelector('.timeline-header');
  const sectionsHtml = list.length ? list
    .sort((a,b)=>(a.order??0)-(b.order??0))
    .map(renderServiceSection).join('')
    : '<div class="app-section" style="text-align:center;color:var(--subtle);padding:28px">No services yet.</div>';
  container.innerHTML = '';
  if(header) container.appendChild(header);
  container.insertAdjacentHTML('beforeend', sectionsHtml);
  updateGeneralStatus(services);
  mountServiceBars();
});

/* ----- Project resolution ----- 
   Use: status.html?project=<slug OR projectId>
*/
function getProjectParam(){
  const u = new URL(location.href);
  return (u.searchParams.get('project') || '').trim();
}
async function resolveProjectId(projectParam){
  if(!projectParam) return null;

  // Firebase push IDs almost always start with "-"
  // If it starts with "-", treat it as a real projectId.
  if(projectParam.startsWith("-")) return projectParam;

  // Otherwise treat it as a slug and resolve via index
  const slugSnap = await get(ref(db, `projectSlugs/${projectParam}`));
  const projectId = slugSnap.val();
  if(projectId) return projectId;

  // Fallback: legacy slug lookup (if you don‚Äôt have projectSlugs populated)
  const q = query(ref(db, "projects"), orderByChild("slug"), equalTo(projectParam), limitToFirst(1));
  const snap = await get(q);
  const val = snap.val();
  if(!val) return null;
  return Object.keys(val)[0];
}

function mountServiceBars(){
  $('#statusContainer').querySelectorAll('.bar-box').forEach(b=>{
    b.addEventListener('mouseenter',e=>{
      const st=e.target.dataset.status;
      const ts = Number(e.target.dataset.ts || 0);
      const d=new Date(ts||Date.now());
      showTooltip(e,`<strong>${d.toLocaleString(undefined,{weekday:'short',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</strong><br>${STATUS_NAMES[st]||st}`);
    });
    b.addEventListener('mousemove',positionTooltip);
    b.addEventListener('mouseleave',hideTooltip);
  });
}

(async function boot(){
  const param = getProjectParam();
  const projectId = await resolveProjectId(param);
  if(!projectId){
    $('#projectName').textContent = "Project not found";
    $('#projectSubtitle').innerHTML = `Add <code>?project=YOUR_SLUG</code> to the URL.`;
    $('#projectRef').textContent = "‚Äî";
    $('#generalStatusLabel').textContent = "No data";
    return;
  }
  $('#projectRef').textContent = projectId;

  // Project meta (public read only if project.public == true via rules)
  onValue(ref(db, `projects/${projectId}`), snap=>{
    const p = snap.val();
    if(!p){ $('#projectName').textContent="Project missing"; return; }
    $('#projectName').textContent = p.name || "Status";
    $('#projectSubtitle').textContent = p.public ? "Public status" : "Private (requires auth)";
  });

  // Announcement
  onValue(ref(db, `announcements/${projectId}`), snap=>{
    const ann = snap.val() || {};
    updateAnnouncement(ann.text || '');
  });

  // Services (realtime listener; no polling)
  onValue(ref(db, `services/${projectId}`), snap=>{
    const services = snap.val() || {};
    window.__lastServices = services;

    const list = Object.values(services);
    const container = $('#statusContainer');
    const header = container.querySelector('.timeline-header');
    const sectionsHtml = list.length ? list
      .sort((a,b)=>(a.order??0)-(b.order??0))
      .map(renderServiceSection).join('')
      : '<div class="app-section" style="text-align:center;color:var(--subtle);padding:28px">No services yet.</div>';

    container.innerHTML = '';
    if(header) container.appendChild(header);
    container.insertAdjacentHTML('beforeend', sectionsHtml);

    updateGeneralStatus(services);
    mountServiceBars();

    // timeline refresh if data changes
    const per = $('#activityPeriod').value;
    const hash = JSON.stringify(services);
    if(hash !== lastTimelineHash){
      lastTimelineHash = hash;
      buildMasterTimeline(services, per);
      $('#activityTimeline').innerHTML='';
      renderNextTimelineSlice();
    }
  });
})();
</script>
</body>
</html>
